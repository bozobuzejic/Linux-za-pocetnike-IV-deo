ANSIBLE

Ansible je alat za automatizaciju zadataka na udaljenim serverima. 

Izvodi se na lokalnoj mašini koju povezujemo sa serverima putem ssh-a i izvršavamo zadatke bez instaliranja "agenta" na serverima.
 
Postoji mnogo modula kojim izvršavamo zadatke kao što su kreiranje korisnika i grupa, instaliranja programa, kopiranja fajlova itd. 

---
Master: Debian10 (sa GUI)

Clients: CentOS8 (bez GUI)

        Na klijentima:
           
           sudo yum install -y epel-release
           sudo yum update
           sudo yum install python3                                                                         .....instaliramo potrebne aplikacije
           
           ip a 
              192.168.0.197
           ip a
              192.168.0.198                                                                                 
           ip a 
              192.168.0.199                                                                                 .....proverimo ip adrese klijenata                                                       
           
        Na masteru:
             
           sudo apt-get update
           sudo apt-get install software-properties-common
           sudo apt-add-repository ppa:ansible/ansible
           sudo apt-get update
           sudo apt-get install ansible
           sudo apt-get install python3                                                                     .....instaliramo potrebne aplikacije
           
           (sudo yum install epel-release
            sudo yum install -y ansible                                                                     .....instaliranje na centos sistemima)
           
           ssh vagrant@192.168.0.197                                                                        .....sa mastera se konektujemo se na svakog 
           ssh vagrant@192.168.0.198                                                                             klijenta zbog autentifikacije
           ssh vagrant@192.168.0.199
          
          
---
~~ Konfiguracija i izrada potrebnih fajlova za ansible, sa komandama (primer 1): Inventory file, Ansible Playbooks, Ansible Role, Ansible ad-hoc commands ~~

---

** Inventory file (datoteka inventara - datoteka hosta - /etc/ansible/hosts)           
           
           sudo vim /etc/ansible/hosts                                                                      .....otvorimo fajl za konfigurisanje mašina 
                ...                                                                                              klijenata (inventory file)
                ...
                [webservers]
                web1 ansible_host=192.168.0.197 ansible_ssh_user=root ansible_ssh_pass=password ansible_python_interpreter=python3       .....user: root         
                web2 ansible_host=192.168.0.198 ansible_ssh_user=vagrant ansible_ssh_pass=password ansible_python_interpreter=python3    .....user: vagrant
                ...
                [sharesrvers]
                share1 ansible_host=192.168.0.199 ansible_ssh_user=vagrant ansible_ssh_pass=password ansible_python_interpreter=python3  .....user: vagrant
                ...
                
                
          Napomena: Svaka playbook radi sa inventory file. Datoteka inventara (/etc/ansible/hosts) sadrži popis servera podeljenih u grupe sa detaljima
                    za svaki server (IP adresa, user, password itd.)
                    
                    
** Ansible Playbooks (skripte za slanje naredbi udaljenim sistemima)

           sudo mkdir /home/user/ansibletest                                                                .....kreiramo folder za ansible-playbook skripte
                                                                                                                           
           sudo vim /home/user/ansibletest/test.yml                                                         .....kreiramo 2 skripte (.yml fajlove) kojima određujemo
               ---                                                                                               zadatke koji će se izvršavati na klijentima
               - name: test book                                                                                           
                 hosts: webservers
                 remote_user: root
                 become: true
                 tasks: 
                   - name: install httpd
                     yum:
                           name: httpd
                           state: latest
                   - name: run httpd
                     service:
                           name: httpd
                           state: started
                   - name: enable httpd
                     service:
                           name: httpd
                           enabled: yes        
                   - name: create content
                     copy:
                           content: "Čestitamo, instalirali ste ansible"
                           dest: /var/www/html/index.html
           
           sudo vim /home/user/ansibletest/test2.yml
               ---
               - name: test book
                 hosts: webservers 
                 remote_user: vagrant
                 become: true
                 tasks: 
                   - name: install httpd
                     yum:
                           name: httpd
                           state: latest
                   - name: run httpd
                     service:
                           name: httpd
                           state: started
                   - name: create content
                     copy:
                           content: "Čestitamo, instalirali ste ansible na drugoj mašini"
                           dest: /var/www/html/index.html
                           
                           
           sudo vim /home/user/ansibletest/test3.yml           
               ---
               - hosts: shareservers
                 remote_user: vagrant
                 become: true
                 tasks:
                   - name: install lldpad package
                     yum:
                           name: lldpad
                           state: latest
                   - name: check lldpad service status
                     service:
                           name: lldpad
                           state: started

                           
                                                                                                                                                    
           ansible-playbook /home/user/ansibletest/test.yml --syntax-check                                  .....čekiramo sintaksu fajlova sa zadacima 
              playbook: test.yml
           ansible-playbook /home/user/ansibletest/test2.yml --syntax-check
              playbook: test2.yml
           
           ansible-playbook /home/user/ansibletest/test.yml                                                 .....pokrećemo ansible da izvrši zadatke za klijenta
                                                                                                                 web1 (192.168.0.197)
           ansible-playbook /home/user/ansibletest/test2.yml                                                .....pokrećemo ansible da izvrši zadatke za klijenta
                                                                                                                 web2 (192.168.0.198)                                                                                                       
           
           
        - Provera na klijentima:
           
           sudo systemctl status httpd
                    
                    
        - Provera sa nekog računara u mreži:    

           Web browser -> http://192.168.0.197 -> enter
                          Čestitamo, instalirali ste ansible
           Web browser -> http://192.168.0.198 -> enter
                          Čestitamo, instalirali ste ansible na drugoj mašini    
  
  
  
** Ansible Roles - role (uloge) čine zbir zadataka koji se mogu premeštati iz jedne pleybook u drugu, mogu se izvoditi samostalno (ali samo kroz playbook fajl)

          ansible-galaxy init /home/user/roles/apache --offline                   .....kreiramo stablo foldera za Ansible Roles (ulogu) pod nazivom apache 
                                                                                       (van mreže) 
          
          tree /home/user/roles/apache                                            .....sa komandom tree izlistamo strukturu direktorijuma apache po dubini:
          /home/user/roles/apache 
          ├── defaults 
          │   └── main.yml 
          ├── files 
          ├── handlers 
          │   └── main.yml 
          ├── meta 
          │   └── main.yml 
          ├── README.md 
          ├── tasks 
          │   └── main.yml 
          ├── templates 
          ├── tests 
          │   ├── inventory 
          │   └── test.yml 
          └── vars 
              └── main.yml 
 
          8 directories, 8 files

          
          cd /home/user/roles/apache                                              .....premestimo se folder /home/user/roles/apache
          
          vim tasks/main.yml                                                      .....kreiramo main.yml fajl (playbook fajla)
              ---
              remote_user: vagrant
              become: true
              - name: install epel
                yum:
                      name: epel-release
                      state: installed
              - name: install httpd 
                yum: 
                      name: httpd 
                      state: latest
              - name: copy index.html file
                      copy: "src=/home/bozo/roles/apache/files/index.html dest=/var/www/html"
              - name: run httpd
                service:
                      name: httpd
                      state: started
              - name: enable httpd
                service:
                      name: httpd
                      enabled: yes                                                .....navedemo sve operacije koje će se izvoditi na klijent-serverima
                            
                    
          vim files/index.html                                                    .....kreiramo index.html stranicu koju će apache server postaviti na web
              Ovo je stranica kreirana za ansible ulogu.
         
         
          vim handlers/main.yml                                                   .....kreiramo playbook fajl koji će restartovati apache servis
              ---
              - name: restart apache
                service: name=httpd state=restarted
           
          vim meta/main.yml                                                       .....dodamo meta podatke u konfiguracioni playbook fajl
             ...
             author: XY
             description: Apache Webserver Role
             company: www.github.com/xyz
             ...
             ...
             
          vim /home/user/runsetup.yml                                             .....kreiramo pokretački fajl koji obuhvata sve mašine-klijente u grupi
              ---                                                                      shareservers koju smo definisali u /etc/ansible/hosts fajlu
              - hosts: shareservers
                roles: 
                - apache
         
         
          ansible-playbook /home/user/runsetup.yml --syntax-check                 .....proverimo sintaksu ansible konfiguracije
         
          ansible-playbook /home/user/runsetup.yml                                .....pokrenemo proces izvršenja predviđenih zadataka na klijentima
         
         
             
** Ansible ad-hoc commands (komande koje se zadaju tokom tekuće sesije: ad-hoc)

          ansible all -m ping                                                               .....sa master mašine šaljemo komandu ping svim mašinama u mreži
             web1 | SUCCESS => {
                 "changed": false,
                 "ping": "pong"
             }
             web2 | SUCCESS => {
                 "changed": false,
                 "ping": "pong"
             }                                                                                   .....odgovor sa svake mašine, pojedinačno
             share1 | SUCCESS => {
                 "changed": false,
                 "ping": "pong"
             }

             
          ansible all -m ping --limit web1                                                  .....sa master mašine šaljemo komandu ping samo mašini web1 u mreži
          ili
          ansible web1 -m ping

          
          ansible all -m copy -a "src=/root/testansible/testfile dest=/tmp/"                .....sa master-a šaljemo naredbu da se kopira fajl testfile na svim
             web1 | CHANGED => {                                                                 mašinama
                 "changed": true,
                 "checksum": "4b77df205f52158a6307ed5f89f97ac25372dafb",
                 "dest": "/tmp/testfile",
                 "gid": 0,
                 "group": "root",
                 "md5sum": "8d7b9b8ed777e5892d4dc37860d403e6",
                 "mode": "0644",
                 "owner": "root",
                 "secontext": "unconfined_u:object_r:admin_home_t:s0",
                 "size": 33,
                 "src": "/root/.ansible/tmp/ansible-tmp-1614023648.172932-170837201178363/source",
                 "state": "file",
                 "uid": 0
             }
             web2 | CHANGED => {
             .............    
             }
             shatre1 | CHANGED => {
             .............
             }
             
          ansible all -m copy -a "src=/root/testansible/testfile dest=/tmp/" --limit web2             .....sa master-a šaljemo naredbu da se kopira fajl  
                                                                                                           testfile na mašini web2 (192.168.0.198)
                

          ansible all -m yum -a 'name=ncdu state=present'                                             .....sa master-a šaljemo naredbu da se instalira ncdu                                    
             share2 | FAILED! => {                                                                         program na svim mašinama
                 "ansible_facts": {
                     "pkg_mgr": "dnf"
                 },
                 "changed": false,
                 "msg": "This command has to be run under the root user.",
                 "results": []                                                                             .....instalacija nije uspela na mašini share1
             }                                                                                                  jer user mašine nije root user na inventory fajlu
             web2 | FAILED! => {                                                                         
                 "ansible_facts": {
                     "pkg_mgr": "dnf"
                 },
                 "changed": false,
                 "msg": "This command has to be run under the root user.",
                 "results": []                                                                             .....instalacija nije uspela na mašini web2
             }                                                                                                  jer user mašine nije root user na inventory fajlu 
             web1 | CHANGED => {                               
                 "ansible_facts": {
                     "pkg_mgr": "dnf"
                 },
             "changed": true,
             "msg": "",
             "rc": 0,
             "results": [
                 "Installed: ncdu",
             "Installed: ncdu-1.15.1-1.el8.x86_64"
                 ]                                                                                         .....instalacija je uspela na mašini web1 
             }                                                                                                  jer je user mašine root user na inventory fajlu
     
     
          ansible all -m yum -a 'name=ncdu state=present' --limit web2 -b --become-user=root          .....sa master-a šaljemo naredbu da se instalira ncdu 
             wget2 | CHANGED => {                                                                          program na wget2 (192.168.0.198) sa pribavljenim
                 "ansible_facts": {                                                                        root ovlašćenjima (-b --become-user=root)
                     "pkg_mgr": "dnf"
                 },
                 "changed": true,
                 "msg": "",
                 "rc": 0,
                 "results": [
             "Installed: ncdu",
             "Installed: ncdu-1.15.1-1.el8.x86_64"
                 ]
             }


          ansible all -m yum -a 'name=wget state=present' --limit share1 -b --become-user=root       .....sa master-a šaljemo naredbu da se instalira wget 
                                                                                                          program na share1 (192.168.0.199) sa pribavljenim 
                                                                                                          root ovlašćenjima (-b --become-user=root)
                                                                                                           
          ansible all -m yum -a 'name=ncdu state=absent' --limit share1 -b --become-user=root        .....deinstaliramo ncdu program sa share1 mašine
          
          
          
         
          ansible all -m shell -a "cat /etc/passwd|grep -i vagrant" -s --ask-sudo-pass                .....metoda na starijim verzijama ansible za pokretanje 
             web1 | CHANGED | rc=0 >>                                                                      sa sudo privilegijama na svim mašinama uz password
             vagrant:x:1000:1000::/home/vagrant:/bin/bash                                                          

             web2 | CHANGED | rc=0 >>
             vagrant:x:1000:1000::/home/vagrant:/bin/bash
             
             share1 | CHANGED | rc=0 >>
             vagrant:x:1000:1000::/home/vagrant:/bin/bash



          ansible all -m shell -a "cat /etc/passwd|grep -i vagrant" -s --ask-sudo-pass --limit web2        .....metoda na starijim verzijama ansible za pokretanje 
             SUDO password: password                                                                            sa sudo privilegijama samo na mašini web2
             web2 | CHANGED | rc=0 >>                                                                           
             vagrant:x:1000:1000::/home/vagrant:/bin/bash                                                        
         
         
          ansible all -m shell -a "cat /etc/passwd|grep -i vagrant" -b -K                                  .....nova metoda za pokretanje sa sudo privilegijama
             SUDO password: password                                                                            uz password (izlistava liniju iz passwd fajla za 
                                                                                                                usera vagrant na svim mašinama)
         
          
          ansible share1 -m shell -a "cat /etc/passwd|grep -i vagrant"                                     .....izlistava liniju iz passwd fajla za usera vagrant
             vagrant:x:1000:1000::/home/vagrant:/bin/bash                                                       na share1 mašini

         
          ansible webservers -m shell -a "cat /etc/passwd|grep -i vagrant"                                 .....izlistava liniju iz passwd fajla za usera vagrant                        
             web1 | CHANGED | rc=0 >>                                                                           na mašinama u grupi webservers (iz inventory fajla)
             vagrant:x:1000:1000::/home/vagrant:/bin/bash

             web2 | CHANGED | rc=0 >>
             vagrant:x:1000:1000::/home/vagrant:/bin/bash
          
          
          ansible shareservers -m shell -a "cat /etc/passwd|grep -i vagrant"                               .....izlistava liniju iz passwd fajla za usera vagrant  
             share1 | CHANGED | rc=0 >>                                                                         na mašinama u grupi shareservers (iz inventory fajla)
             vagrant:x:1000:1000::/home/vagrant:/bin/bash                                                       

             
             
          ansible webservers -m file -a "dest=/home/vagrant/test mode=777 owner=vagrant group=vagrant state=directory" .....na mašinama u grupi webservers kreiramo
                                                                                                                            folder test sa naznačenim parametrima
          
          ansible web1 -m file -a "dest=/home/vagrant/test state=absent"                                               .....sa mašine web1 brišemo folder test                                                                                                     
   
   
---   
   
~~ Konfiguracija i izrada potrebnih fajlova za ansible, sa komandama (primer2): Inventory file, Ansible Playbooks ~~  

---   
   
   - Kreiranje novog inventory fajla
   
          mkdir -p /home/user/ansiblelab/inventory
         
   
          vim /home/user/ansiblelab/inventory/host1
              share ansible_host=192.168.0.199 ansible_ssh_user=vagrant ansible_ssh_pass=password ansible_python_interpreter=python3
              
              
   - Kreiranje playbook fajla
   
          mkdir -p /home/user/ansiblelab/playbook
   
          vim /home/user/ansiblelab/playbook/install_to_share.yml
              --- 
              - hosts: share
                become: true
                tasks:
                      - name: install epel
                        yum:
                               name: epel-release
                               state: installed
                      - name: install nginx
                        yum:
                               name: nginx
                               state: installed
                      - name: run nginx
                        service:
                               name: nginx
                               state: started
                      - name: enable httpd
                        service:
                               name: nginx
                               enabled: yes            
                      - name: install vsftpd
                        yum:
                               name: vsftpd
                               state: installed
                      - name: run vsftpd
                        service:
                               name: vsftpd
                               state: started
                      - name: enable vsftpd
                        service:
                               name: vsftpd
                               enabled: yes             
                      - name: install lftp
                        yum:
                               name: lftp
                               state: installed          
                
                  
                  
          ansible-playbook -i /home/user/ansiblelab/inventory/host1 /home/user/ansiblelab/playbook/install_to_share.yml   .....pokrenemo zadatke na share mašini           
   
          
   
   