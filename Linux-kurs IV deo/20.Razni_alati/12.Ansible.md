ANSIBLE

Ansible je alat za automatizaciju zadataka na udaljenim serverima.
 
Izvodi se na lokalnoj mašini koju povezujemo sa serverima putem ssh-a i izvršavamo zadatke bez instaliranja "agenta" na serverima.

Postoji mnogo modula kojim izvršavamo zadatke kao što su kreiranje korisnika i grupa, instaliranja programa, kopiranja fajlova itd. 

      Napomena: Svi prikazani primeri su rađeni na virtuelnim mašinama u VirtualBox-u (neke su kreirane Vagrant command-line alatom)
                Na mašinama bi trebalo da su intalirani ssh servis, python3 i vim, podešena statička ip adresa, omogućeni portovi 
                za ssh, http (22, 80 i drugi) u firewall-u.
                Struktura se sastoji od master mašine i klijenata.

     -Master (lokalna, kontrolna mašina koja upravlja mnoštvom udaljenih računara, klijenata preko ssh protokola): debianbb - Debian10 (sa GUI)

     -Clients (udaljeni računari kojima se upravlja sa mastera): web - CentOS8 (bez GUI); db - CentOS8 (bez GUI); share - CentOS8 (bez GUI)


           debianbb:      ip a                                                                           
                          192.168.0.200                                                                     .....proverimo ip adresu master servera          
           web:           ip a 
                          192.168.0.197
           db:            ip a
                          192.168.0.198                                                                                 
           share:         ip a 
                          192.168.0.199                                                                     .....proverimo ip adrese klijenata                                                       
            
          
          *Na masteru:
        
           sudo apt-get update
           sudo apt-get install software-properties-common
           sudo apt-add-repository ppa:ansible/ansible
           sudo apt-get update
           sudo apt-get install ansible
           sudo apt-get install python3                                                                     .....instaliramo potrebne aplikacije
           
           (sudo yum install epel-release
            sudo yum install -y ansible                                                                     .....instaliranje na centos sistemima)
           
           ssh vagrant@192.168.0.197                                                                        .....obavezno se sa mastera konektujemo na svakog 
           ssh vagrant@192.168.0.198                                                                             klijenta zbog autentifikacije
           ssh vagrant@192.168.0.199
           ssh vagrant@192.168.0.35
          
          
           Dva osnovna ansible fajla preko kojih izvršavamo zadatke sa mastera na klijentima su:
           
           -Inventory:  /etc/ansible/hosts                                                                  .....inventory fajl sadrži spisak klijenata
           -Playbook:   /___/___/nekinaziv.yml                                                              .....fajl sa zadacima koje ansible izvršava na 
                                                                                                                 hostovima navedenim u inventory fajlu
           
          *Na klijentima (CentOS8 mašine) :
          
           sudo yum install -y epel-release
           sudo yum update
           sudo yum install python3                                                                         .....instaliramo potrebne aplikacije
           
          
          

      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~VEŽBA 1~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


      ** INVENTORY FILE (default datoteka inventara - datoteka hosta - /etc/ansible/hosts)           
           
           sudo vim /etc/ansible/hosts                                                                      .....otvorimo fajl za konfigurisanje mašina 
                ...                                                                                              klijenata (inventory file)
                ...
                [webservers]
                web1 ansible_host=192.168.0.197 ansible_ssh_user=root ansible_ssh_pass=nekipassword ansible_python_interpreter=python3       .....mašina web,
                                                                                                                                                  user: root         
                web2 ansible_host=192.168.0.198 ansible_ssh_user=vagrant ansible_ssh_pass=nekipassword ansible_python_interpreter=python3    .....mašina db, 
                ...                                                                                                                               user: vagrant
                ...
                [sharesrvers]
                share1 ansible_host=192.168.0.199 ansible_ssh_user=vagrant ansible_ssh_pass=password ansible_python_interpreter=python3      .....mašina share, 
                ...                                                                                                                               user: vagrant
                ...
                
                
        Proba sa ad-hoc naredbom: 
                
                ansible -i /etc/ansible/hosts all -m yum -a 'name=wget state=present'                       .....instaliramo wget aplikaciju na webserverima
                       
                
                  
         Napomena 1: Default datoteka inventara (/etc/ansible/hosts) sadrži popis servera podeljenih u grupe sa detaljima za svaki server kao što su 
                     IP adresa, user, password itd. Odrednice kao što su ansible_ssh_user ne moraju biti unete u inventory (hosts) fajl ali se tada 
                     ad-hoc naredbi za izvršenje nekog zadatka dodaje -b (daje ovlašćenja korisniku na udaljenom računaru) 
                 |   i -K (dodeljuje sudo prava korisniku na udaljenom računaru: tad unosimo password prilikom izvršenja naredbe)
                 |    
                 |-> Primer:
                     
                     sudo vim /etc/ansible/hosts                                                            .....otvorimo fajl za konfigurisanje mašina 
                     ...                                                                                         klijenata (inventory file)
                     ...
                     [webservers]            
                     webgate ansible_host=192.168.0.196 ansible_python_interpreter=python3                  .....upišemo ime i adresu udaljenog računara                                                                                     
                     ...                                                                                         (bez imena usera i passworda) komanda će biti:
                
                     ansible all -m yum -a 'name=ncdu state=present' -b -K                                       .....naredba prilikom izvršenja zahteva da
                                                                                                                      unesemo password za usera udaljenog sistema

                                                                                                                       
                                                                                                                        
      ** Ansible ad-hoc commands (komande koje se zadaju tokom tekuće sesije: ad-hoc)

          ansible all -m ping                                                               .....sa master mašine šaljemo komandu ping svim mašinama u mreži
             web1 | SUCCESS => {
                 "changed": false,
                 "ping": "pong"
             }
             web2 | SUCCESS => {
                 "changed": false,
                 "ping": "pong"
             }                                                                                   .....odgovor sa svake mašine, pojedinačno
             share1 | SUCCESS => {
                 "changed": false,
                 "ping": "pong"
             }

             
          ansible /etc/ansible/hosts all -m ping --limit web1                               .....sa master mašine šaljemo komandu ping samo mašini web1 u mreži
          ili
          ansible web1 -m ping

          
          ansible all -m copy -a "src=/root/testansible/testfile dest=/tmp/"                .....sa master-a šaljemo naredbu da se kopira fajl testfile na svim
             web1 | CHANGED => {                                                                 mašinama
                 "changed": true,
                 "checksum": "4b77df205f52158a6307ed5f89f97ac25372dafb",
                 "dest": "/tmp/testfile",
                 "gid": 0,
                 "group": "root",
                 "md5sum": "8d7b9b8ed777e5892d4dc37860d403e6",
                 "mode": "0644",
                 "owner": "root",
                 "secontext": "unconfined_u:object_r:admin_home_t:s0",
                 "size": 33,
                 "src": "/root/.ansible/tmp/ansible-tmp-1614023648.172932-170837201178363/source",
                 "state": "file",
                 "uid": 0
             }
             web2 | CHANGED => {
             .............    
             }
             shatre1 | CHANGED => {
             .............
             }
             
             
          ansible all -m copy -a "src=/root/testansible/testfile dest=/tmp/" --limit web2             .....sa master-a šaljemo naredbu da se kopira fajl  
                                                                                                           testfile na udaljenu mašinu web2 (192.168.0.198)
          
          ansible webgate -m command -a "cp /home/user/Downloads/test.txt /home/user/Documents"       .....sa master-a šaljemo naredbu da se na udaljenoj mašini 
                                                                                                           kopira fajl test.txt iz foldera Downloads u folder 
                                                                                                           Documents
          ansible webgate -m command -a "mv /home/user/Documents/test.txt /home/user"                 .....sa master-a šaljemo naredbu da se na udaljenoj mašini 
                                                                                                           pomeri fajl test.txt iz foldera Documents u folder 
                                                                                                           user
          ansible webservers -m file -a "dest=/home/vagrant/test mode=777 owner=vagrant group=vagrant state=directory" .....na mašinama u grupi webservers kreiramo
                                                                                                                            folder test sa naznačenim parametrima
                                                                                                                          
          ansible web1 -m file -a "dest=/home/vagrant/test state=absent"                              .....sa udaljene mašine web1 brišemo folder test
                                                                                               
          
          ansible webgate -m command -a "ls -la /home/user"                                           .....izlistava sadržaj user foldera na udaljenoj mašini
                                                                                                           webgate
                                                                                                                
          ansible webservers -m command -a "ls -la /home/user"                                        .....izlistava sadržaj user foldera na udaljenim mašinama                                                             
                                                                                                           webservers grupe
                                                                                                                                                                                                                                              
          

          ansible all -m yum -a 'name=ncdu state=present'                                             .....sa master-a šaljemo naredbu da se instalira ncdu                                    
             share2 | FAILED! => {                                                                         program na svim mašinama
                 "ansible_facts": {
                     "pkg_mgr": "dnf"
                 },
                 "changed": false,
                 "msg": "This command has to be run under the root user.",
                 "results": []                                                                             .....instalacija nije uspela na mašini share1
             }                                                                                                  jer user mašine nije root user na inventory fajlu
             web2 | FAILED! => {                                                                         
                 "ansible_facts": {
                     "pkg_mgr": "dnf"
                 },
                 "changed": false,
                 "msg": "This command has to be run under the root user.",
                 "results": []                                                                             .....instalacija nije uspela na mašini web2
             }                                                                                                  jer user mašine nije root user na inventory fajlu 
             web1 | CHANGED => {                               
                 "ansible_facts": {
                     "pkg_mgr": "dnf"
                 },
             "changed": true,
             "msg": "",
             "rc": 0,
             "results": [
                 "Installed: ncdu",
             "Installed: ncdu-1.15.1-1.el8.x86_64"
                 ]                                                                                         .....instalacija je uspela na mašini web1 
             }                                                                                                  jer je user mašine root user na inventory fajlu
     
     
          ansible all -m yum -a 'name=ncdu state=present' --limit web2 -b --become-user=root          .....sa master-a šaljemo naredbu da se instalira ncdu 
             wget2 | CHANGED => {                                                                          program na wget2 (192.168.0.198) sa pribavljenim
                 "ansible_facts": {                                                                        root ovlašćenjima (-b prenosi ovlašćenja a
                     "pkg_mgr": "dnf"                                                                      --become-user=root kaže da se ovlašćenja prenose na root)
                 },
                 "changed": true,
                 "msg": "",
                 "rc": 0,nginx_role
                 "results": [
             "Installed: ncdu",
             "Installed: ncdu-1.15.1-1.el8.x86_64"
                 ]
             }


          ansible all -m yum -a 'name=wget state=present' --limit share1 -b --become-user=root       .....sa master-a šaljemo naredbu da se instalira wget 
                                                                                                          program na share1 (192.168.0.199) sa pribavljenim 
                                                                                                          root ovlašćenjima (-b prenosi ovlašćenja a 
                                                                                                          --become-user=root kaže da se ovlašćenja prenose na root)
                                                                                                           
          ansible all -m yum -a 'name=ncdu state=absent' --limit share1 -b --become-user=root        .....deinstaliramo ncdu program sa share1 mašine
          
                                              
         
          ansible all -m shell -a "cat /etc/passwd|grep -i vagrant" -s --ask-sudo-pass                .....metoda na starijim verzijama ansible za pokretanje 
             web1 | CHANGED | rc=0 >>                                                                      sa sudo privilegijama na svim mašinama uz password
             vagrant:x:1000:1000::/home/vagrant:/bin/bash                                                          

             web2 | CHANGED | rc=0 >>
             vagrant:x:1000:1000::/home/vagrant:/bin/bash
             
             share1 | CHANGED | rc=0 >>
             vagrant:x:1000:1000::/home/vagrant:/bin/bash



          ansible all -m shell -a "cat /etc/passwd|grep -i vagrant" -s --ask-sudo-pass --limit web2        .....metoda na starijim verzijama ansible za pokretanje 
             SUDO password: password                                                                            sa sudo privilegijama samo na mašini web2
             web2 | CHANGED | rc=0 >>                                                                           
             vagrant:x:1000:1000::/home/vagrant:/bin/bash                                                        
         
         
          ansible all -m shell -a "cat /etc/passwd|grep -i vagrant" -b -K                                  .....nova metoda za pokretanje sa sudo privilegijama
             SUDO password: password                                                                            uz password (izlistava liniju iz passwd fajla za 
                                                                                                                usera vagrant na svim mašinama)
         
          
          ansible share1 -m shell -a "cat /etc/passwd|grep -i vagrant"                                     .....izlistava liniju iz passwd fajla za usera vagrant
             vagrant:x:1000:1000::/home/vagrant:/bin/bash                                                       na share1 mašini

         
          ansible webservers -m shell -a "cat /etc/passwd|grep -i vagrant"                                 .....izlistava liniju iz passwd fajla za usera vagrant                        
             web1 | CHANGED | rc=0 >>                                                                           na mašinama u grupi webservers (iz inventory fajla)
             vagrant:x:1000:1000::/home/vagrant:/bin/bash

             web2 | CHANGED | rc=0 >>
             vagrant:x:1000:1000::/home/vagrant:/bin/bash
          


             
         ansible all -m yum -a 'name=wget state=present' --limit share1                                    .....na mašinu share1 instaliramo wget aplikaciju
          
         ansible webservers -m yum -a "name=httpd state=absent"                                            .....sa mašina u grupi webservers deinstaliramo httpd
                                                                                                                servis
             
                    
     ** PLAYBOOK FILE (skripte za slanje naredbi udaljenim sistemima) 
        Ansible playbook: skripta koja sadrži sve zadatke koje treba izvršiti sa svim elementima potrebnim za izvršavanje zadataka.

           sudo mkdir /home/user/ansibletest                                                                .....kreiramo folder za ansible-playbook skripte
                                                                                                                           
           sudo vim /home/user/ansibletest/test.yml                                                         .....kreiramo 2 skripte (.yml fajlove) kojima određujemo
               ---                                                                                               zadatke koji će se izvršavati na klijentima
               - name: test book                                                                                           
                 hosts: webservers
                 remote_user: root
                 become: true                                                                                    .....become obezbeđuje izvršenje zadataka sa sudo i
                 tasks:                                                                                               su privilegijama
                   - name: install httpd
                     yum:
                           name: httpd
                           state: latest
                   - name: run httpd
                     service:
                           name: httpd
                           state: started
                   - name: enable httpd
                     service:
                           name: httpd
                           enabled: yes        
                   - name: create content
                     copy:
                           content: "Čestitamo, instalirali ste ansible"
                           dest: /var/www/html/index.html
           
           sudo vim /home/user/ansibletest/test2.yml
               ---
               - name: test book
                 hosts: webservers 
                 remote_user: vagrant
                 become: true
                 tasks: 
                   - name: install httpd
                     yum:
                           name: httpd
                           state: latest
                   - name: run httpd
                     service:
                           name: httpd
                           state: started
                   - name: create content
                     copy:
                           content: "Čestitamo, instalirali ste ansible na drugoj mašini"
                           dest: /var/www/html/index.html
                           
                           
           sudo vim /home/user/ansibletest/test3.yml           
               ---
               - hosts: shareservers
                 remote_user: vagrant
                 become: true
                 tasks:
                   - name: install lldpad package
                     yum:
                           name: lldpad
                           state: latest
                   - name: check lldpad service status
                     service:
                           name: lldpad
                           state: started

                           
                                                                                                                                                    
           ansible-playbook /home/user/ansibletest/test.yml --syntax-check                                  .....čekiramo sintaksu fajlova sa zadacima 
              playbook: test.yml
           ansible-playbook /home/user/ansibletest/test2.yml --syntax-check
              playbook: test2.yml
           
           ansible-playbook /home/user/ansibletest/test.yml                                                 .....pokrećemo ansible da izvrši zadatke za klijenta
                                                                                                                 web1 (192.168.0.197)
           ansible-playbook /home/user/ansibletest/test2.yml                                                .....pokrećemo ansible da izvrši zadatke za klijenta
                                                                                                                 web2 (192.168.0.198)                                                                                                       
           
           
        - Provera na klijentima:
           
           sudo systemctl status httpd
                    
                    
        - Provera sa nekog računara u mreži:    

           Web browser -> http://192.168.0.197 -> enter
                          Čestitamo, instalirali ste ansible
           Web browser -> http://192.168.0.198 -> enter
                          Čestitamo, instalirali ste ansible na drugoj mašini    
  
  
  
     ** ROLES - Ansible roles čini zbir zadataka koji se mogu premeštati iz jedne pleybook u drugu, mogu se izvoditi samostalno (ali samo preko playbook fajla)
        Asible roles (uloge) automatski određuju var fajlove, zadatake i nosioce procesa na unapred poznatoj strukturi foldera i fajlova.
        Ansible uloge se koriste za pojednostavljivanje Ansible playbook-a (playbook možemo rastaviti na više pojedinačnih uloga koje su višekratne i nezavisne
        jedna od druge).
   
        Ansible traži uloge na dve lokacije: /etc/ansible/roles ili u drugom folderu roles s tim da u fajlu kojim se pokreću uloge mora biti navedema
        kvalifikovana putanja do napisanih rola.
   
        U Ansible je uključen Ansible Galaxy: besplatna web platforma za pronalaženje, preuzimanje, pregledanje i deljenje svih vrsta uloga.
        Ansible Galaxy omogućuje preuzimanje uloga i daje okvir za kreiranje sopstvenih uloga u unapred struktuiranom direktorijumu.
   
   
      Primer 1:
      
      
       Napomena: Prvo u /etc/ansible/hosts fajlu (inventory fajl) definšemo grupe udaljenih servera kojima sa mastera, preko ansible, šaljemo zadatke 
       
      
          ansible-galaxy init /home/user/roles/apache --offline              .....kreiramo stablo foldera za Ansible Roles (ulogu) pod nazivom apache 
                                                                                  (van mreže) 
          
          tree /home/user/roles/apache                                       .....sa komandom tree izlistamo strukturu direktorijuma apache po dubini:
          /home/user/roles/apache 
          ├── defaults                                                            .....sadrži zadate (default) varijable za ulogu, imaju nizak prioritet
          │   └── main.yml 
          ├── files                                                               .....folder files sadrži statične datoteke koje se implementirati kroz uloge
          ├── handlers                                                            .....folder hendlers sadrži obrađivače koji se, kad se zadatak izvrši, 
          │   └── main.yml                                                             pokreće posle ključne reči navedene u notify ključu
          ├── meta                                                                .....sadrži metapodatke o rolama uključujući zavisnosti uloga
          │   └── main.yml 
          ├── README.md 
          ├── tasks                                                               .....sadrži listu zadataka koji će se izvršavati
          │   └── main.yml 
          ├── templates                                                           .....sadrži predloške (template) koje raspoređujemo putem ove uloge
          ├── tests 
          │   ├── inventory 
          │   └── test.yml 
          └── vars                                                                .....sadrži ostale varijable za uloge, imaju najviši nivo prvenstva
              └── main.yml 
 
          8 directories, 8 files

      Napomena: Prema zadatim postavkama Ansible će u svakom direktorijumu unutar uloga tražiti main.yml fajl koji određuje šta se izvršava.
                U neke foldere se mogu dodati drugi .yml fajlovi (na primer, zadaci specifični za pojedine platforme mogu se dodati u task folder: redhat.yml,
                redhat.yml itd).
      
      
          cd /home/user/roles/apache                                              .....premestimo se folder /home/user/roles/apache

          vim tasks/main.yml                                                      .....kreiramo main.yml fajl (playbook fajla)
              ---
              - name: install epel
                yum:
                      name: epel-release
                      state: installed
              - name: install httpd 
                yum: 
                      name: httpd 
                      state: latest
              - name: copy index.html file
                      copy: "src=/home/user/roles/apache/files/index.html dest=/var/www/html"
              - name: run httpd
                service:
                      name: httpd
                      state: started
              - name: enable httpd
                service:
                      name: httpd
                      enabled: yes                                                .....navedemo sve operacije koje će se izvoditi na klijent-serverima
                            
                    
          vim files/index.html                                                    .....kreiramo index.html stranicu koju će apache server postaviti na web
              Ovo je stranica kreirana za ansible ulogu.
         
         
          vim handlers/main.yml                                                   .....kreiramo fajl koji će restartovati apache servis
              ---
              - name: restart apache
                service: name=httpd state=restarted
           
          vim meta/main.yml                                                       .....dodamo meta podatke u konfiguracioni playbook fajl
             ...
             author: XY
             description: Apache Webserver Role
             company: www.github.com/xyz
             ...
             ...
             
          vim /home/user/runsetup.yml                                             .....kreiramo playbook pokretački fajl kojim pozivamo kreiranu ulogu 
              ---                                                                      (u ovom slučaju obuhvata sve mašine-klijente u grupi shareservers koju smo 
              - hosts: shareservers                                                    definisali u /etc/ansible/hosts fajlu
                roles:
                - apache                                                               .....sadrži kvalifikovanu putanju do napisane role 
         
         
          ansible-playbook /home/user/runsetup.yml --syntax-check                 .....proverimo sintaksu ansible konfiguracije
         
          ansible-playbook /home/user/runsetup.yml                                .....pokrenemo proces izvršenja predviđenih zadataka na klijentu
         
         
         
         
     Primer 2:
     
     
        *Inventory:
          
          sudo vim /etc/ansible/hosts                                                                 .....otvorimo fajl za konfigurisanje mašina 
                ...                                                                                        klijenata (inventory file)
                ...
                [webservers]            
                webgate ansible_host=192.168.0.196                                                    .....upišemo ime i adresu udaljenog računara                                                                                     
                ...                                                                                        (bez imena usera i passworda)
     
     
        *Ansible roles:
          
          ansible-galaxy init /home/user/roles/nginx_role                         .....kreiramo stablo foldera za Ansible Roles (ulogu) pod nazivom nginx_role
        
          vim /home/user/roles/nginx_role/tasks/main.yml                          .....određujemo zadatke koji će se izvršavati na udaljenom računaru
            ---
            - name: install nginx                                                      .....zadatak: instaliranje nginx 
              yum: name=nginx state=latest                                                  .....naredba za instalaciju poslednje verzije nginx
            - name: copy index.html template                                           .....zadatak: kopiranje predloška (template) za index.html fajl
              template: src=templates/index.html dest=/usr/share/nginx/html                 .....naredba za izvršenje kopiraja sa mastera na klijenta 
              notify: restart nginx                                                         .....naredba za restart nginx
            - name: enable and start service                                           .....zadatak: omogućiti servis pri dizanju sistema i pokrenuti ga
              service:                                                                      .....nareba za izvršenje navedenih operacija na servisu nginx
                  name: nginx
                  enabled: yes
                  state: started

     
          vim /home/user/roles/nginx_role/templates/index.html                .....kreiramo template za index.html stranicu umesto default index.html stranice
            <!DOCTYPE html>
            <html>
            <head>
            <title>Moj nginx webserver</title>
            </head>
            <body><h1>Dobro dosli na moju {{ type_of_webserver }} stranicu 4</h1></body>     .....{{ type_of_webserver }} će upisati važeću varijablu 
            </html>                                                                               koju određujemo u /home/user/roles/nginx_role/defaults/main.yml
     
          vim /home/user/roles/nginx_role/handlers/main.yml                   .....kreiramo ulogu (fajl za obrađivača koji će restartovati nginx servis
            - name: restart nginx service
              service: name=nginx state=restarted
              listen: "restart nginx"     
  
  
          vim /home/user/roles/nginx_role/defaults/main.yml                   .....konfigurišemo default varijablu za tip servera (tip servera koji ovde
            ---                                                                    odredimo će biti prikazan u index.html fajlu) 
            type_of _webserver: Nginx                                              .....tip servera Nginx

              
        *Playbook:
     
          vim /home/user/nginxsetup.yml                                       .....kreiramo pokretački fajl kojim pozivamo kreiranu rolu 
            ---                                                                    (u ovom slučaju obuhvata sve mašine-klijente u grupi shareservers koju smo 
            - hosts: webservers                                                    definisali u /etc/ansible/hosts fajlu
              become: yes
              roles:
              - nginx_role 
                                                                      _ 
              vars:                                                    |________________naknadno u playbook fajl ubacujemo varijablu kojom menjamo tip servera iz                             
                  type_of_webserver: "Nginx webgate"                  _|                Nginx u Nginx webgate (čime poništavamo varijablu datu u default roli) 
                                                                 
        
          ansible-playbook /home/user/nginxsetup.yml -b -K                    .....pokretanjem playbook fajla nginxsetup.yml pokrećemo izvršenje nginx_role
                                                                                   (svih zadataka i uloga koje smo definisali u main.yml fajlovima odgovarajućih 
                                                                                   rola: tasks, templates, handlers, defaults)
              

         Napomena: Na https://galaxy.ansible.com/ se može pronaći i preuzeti broj gotovih rola
      
      
      
      
     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~VEŽBA 2~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
       
   
     -Kreiranje novog inventory fajla
   
          mkdir -p /home/user/ansiblelab/inventory
         
   
          vim /home/user/ansiblelab/inventory/host1
              share ansible_host=192.168.0.199 ansible_ssh_user=vagrant ansible_ssh_pass=password ansible_python_interpreter=python3
              
              
     -Kreiranje playbook fajla
   
          mkdir -p /home/user/ansiblelab/playbook
   
          vim /home/user/ansiblelab/playbook/install_to_share.yml
              --- 
              - hosts: share
                become: true
                tasks:
                      - name: install epel
                        yum:
                               name: epel-release
                               state: installed
                      - name: install nginx
                        yum:
                               name: nginx
                               state: installed
                      - name: run nginx
                        service:
                               name: nginx
                               state: started
                      - name: enable httpd
                        service:
                               name: nginx
                               enabled: yes            
                      - name: install vsftpd
                        yum:
                               name: vsftpd
                               state: installed
                      - name: run vsftpd
                        service:
                               name: vsftpd
                               state: started
                      - name: enable vsftpd
                        service:
                               name: vsftpd
                               enabled: yes             
                      - name: install lftp
                        yum:
                               name: lftp
                               state: installed          
                
                  
                  
          ansible-playbook -i /home/user/ansiblelab/inventory/host1 /home/user/ansiblelab/playbook/install_to_share.yml   .....pokrenemo zadatke na share mašini  
          
   
      Napomena: Ovaj primer pokazuje da inventory file možemo sami kreirati i smestiti u neki direktorijum ali tada u naredbi kojom je prosleđujemo 
                ansible-u moramo navesti putanju (-i /home/user/ansiblelab/inventory/host1) kao što navodimo koji playbook fajl izvršavamo
                (/home/user/ansiblelab/playbook/install_to_share.yml)
       
          
          
          
     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~VEŽBA 3~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~     
          
          
      Master mašina (controller): debianbb (Debian 10)
      Klijent mašina za održavanje balansa (loadbalancer): ubuntubalance (Ubuntu 17 server)
      Klijent Webserver mašine (webserver): web (centOS 8); db (CentOS 8) i share (CentOS 8)
      
      Napomena: Na mašinama bi trebalo da su intalirani ssh servis, programi python3 i vim, podešena statička ip adresa, omogućeni portovi za ssh i http (22 i 80)
                u firewall-u
                
                
      Podešavanja:
      
         sudo vim /etc/hosts                                   .....uredimo hosts fajl na svim mašinama kako bi se olakšala komunikacija
              192.168.0.197 web
              192.168.0.198 db
              192.168.0.199 share
              192.168.0.35  ubuntubalance
              192.168.0.200 debianbb
     
     
        sudo vim .ssh/config                                   .....na mašini debianbb (master) otvaramo novi fajl i upisujemo 
                    Host web                                   
                         User vagrant                              
                         Hostname 192.168.0.197                 
                         Port 22                               
                         IdentityFile ~/.ssh/id_rsa            
                    Host db                                   
                         User vagrant                            
                         Hostname 192.168.0.198                 
                         Port 22                               
                         IdentityFile ~/.ssh/id_rsa      
                    Host share                                   
                         User vagrant                            
                         Hostname 192.168.0.199                 
                         Port 22                               
                         IdentityFile ~/.ssh/id_rsa  
                    Host ubuntubalance                                   
                         User vagrant                              
                         Hostname 192.168.0.35                 
                         Port 22                               
                         IdentityFile ~/.ssh/id_rsa
                        

         
        ssh-keygen -t rsa                                                                  .....kreiramo ključ koji će master mašini omogućiti pristup svakoj  
                                                                                                mašini bez zahteva za password
        cat .ssh/id_rsa.pub|ssh vagrant@web 'cat >> .ssh/authorized_keys'                  .....dostavimo javni ključ na svaku klijent mašinu pojedinačno
        cat .ssh/id_rsa.pub|ssh vagrant@db 'cat >> .ssh/authorized_keys'
        cat .ssh/id_rsa.pub|ssh vagrant@share 'cat >> .ssh/authorized_keys'
        cat .ssh/id_rsa.pub|ssh vagrant@ubuntubalance 'cat >> .ssh/authorized_keys'
        (cat .ssh/id_rsa.pub|ssh bozo@boza 'cat >> .ssh/authorized_keys'                         .....ključ za CentOS7 u VM)
        
        ssh vagrant@web
        ili
        ssh web                                                                            .....sa master (debianbb) mašine se konektujemo na klijent mašine
    
        ssh vagrant@db
        ili
        ssh db

        ssh vagrant@share
        ili
        ssh share
        
        ssh vagrant@ubuntubalance
        ili
        ssh ubuntubalance
        
        
        
        INVENTORY
        
        mkdir -p /home/user/ansiblework/{inventory,playbook)                               .....kreiramo radne foldere za ansible
        
        vim /home/user/ansiblework/inventory/development.txt                               .....kreiramo novu listu servera (inventory fajl)
            [controller]                                                                        .....master mašina na koju je instaliran ansible
            debianbb ansible_connection=local

            [loadbalancer]                                                                      .....mašina koja distribuira mrežni saobraćaj na više servera
            ubuntubalance ansible_user=vagrant ansible_python_interpreter=python3

            [webserver]                                                                         .....grupa mašina koje imaju funkciju webservera
            web ansible_user=vagrant ansible_python_interpreter=python3
            db ansible_user=vagrant ansible_python_interpreter=python3
            share ansible_user=vagrant ansible_python_interpreter=python3
            
        ansible -i /home/user/ansiblework/inventory/development.txt --list-hosts all       .....izlistamo hostove iz inventory fajla
        hosts (5):
          ubuntubalance
          debianbb
          web
          db
          share
          
        vim /home/user/ansiblework/ansible.cfg                                             .....kreiramo novi konfiguracioni ansible.cfg fajl i upišemo putanju
        [defaults]                                                                              do default inventory liste (development.txt) 
        inventory = /home/user/ansiblework/inventory/development.txt
        
        sudo vim /etc/ansible/hosts                                                        .....zakomentarišemo sve otvorene linije sa inventarom hostova
        sudo mv /etc/ansible/ansible.cfg /etc/ansible/ansible.cfg.origin                   .....izmenimo naziv originalnog ansible.cfg fajla
        sudo ln -s /home/user/ansiblework/ansible.cfg /etc/ansible/ansible.cfg             .....kreiramo soft link od novog ansible.cfg fajla do 
                                                                                                /etc/ansible/ansible.cfg fajla
        ansible --list-hosts all                                                           .....izlistamo hostove
        hosts (5):
          ubuntubalance
          debianbb
          web
          db
          share        

        ansible --list-hosts webserver
        hosts (2):
          web
          db
          share
          
        ansible -m ping all
        ansible -m command -a "ls" all
        
    
    
        PLAYBOOK
      
        1.
        sudo vim /home/user/ansiblework/playbook/start.yml                                       .....playbook skripta kojom određujemo zadatke svim mašinama
            ---
            - hosts: all
              tasks:
                - name: list files in folder
                  command: ls 
              
        ansible-playbook /home/user/ansiblework/palybook/start.yml                               .....pokrenemo zadatak na svim mašinama 
        
    
        2.
        sudo vim /home/user/ansiblework/playbook/webserver.yml                                   .....playbook skripta kojom regulišemo zadatke webserverima
            ---
            - hosts: webserver
              become: true
              tasks:
                - name: install httpd
                  yum: name=httpd state=present update_cache=yes
                - name: deleted index.html
                  file: path=/var/www/html/index.html state=absent
                  notify: restart httpd
              handlers:
                - name: restart httpd
                  service: name=httpd state=restarted
      
            - hosts: web
              become: true
              tasks:
                - name: set up index.html for first web server
                  copy: content="<html>
                                 <header><title>Dobro došli na webserver</title></header>
                                 <body>Zdravo sa webservera!</body></html>" dest=/var/www/html/index.html mode=0644
                  notify: restart httpd
              handlers:
                 - name: restart httpd
                   service: name=httpd state=restarted

            - hosts: db
              become: true
              tasks:
                - name: set up index.html for second web server
                  copy: content="<html>
                                 <header><title>Dobro došli na webserver 2</title></header>
                                 <body>Zdravo sa webservera 2!</body></html>" dest=/var/www/html/index.html mode=0644
                  notify: restart httpd
              handlers:
                 - name: restart httpd
                   service: name=httpd state=restarted
                   
            - hosts: share
              become: true
              tasks:
                - name: set up index.html for second web server
                  copy: content="<html>
                                 <header><title>Dobro došli na webserver 3</title></header>
                                 <body>Zdravo sa webservera share (3)!</body></html>" dest=/var/www/html/index.html mode=0644
                  notify: restart httpd
              handlers:
                 - name: restart httpd
                   service: name=httpd state=restarted      
      
      
        ansible-playbook /home/user/ansiblework/playbook/webserver.yml                           .....pokrenemo zadatke na webserverima           
      
      
        3.
        mkdir /home/user/ansiblework/templates                                                   .....kreiramo folder za predloške (templates)
        sudo vim /home/usor/ansiblework/templates/nginx.conf.j2                                  .....konfigurišemo predložak za loadbalancer mašinu koji će
              upstream test {                                                                         omogućiti kontrolu nad webserverima 
              {% for server in groups.webserver %}
              server {{ server }};
              {% endfor %}
              }

              server {
              listen 80;

              location / {
              proxy_pass http://test;
              }
              }

        4.
        sudo vim /home/user/ansiblework/playbook/loadbalancer.yml                               .....konfigurišemo playbook za loadbalancer (server koji distribuira 
            ---                                                                                      mrežni saobraćaj na više servera radi rasterećenja saobraćaja);
            - hosts: loadbalancer                                                                    loadbalancer radi sa nginx servisom
              become: true
              tasks:
                - name: install nginx
                  apt: name=nginx state=present update_cache=yes
                - name: start nginx
                  service: name=nginx state=started enabled=yes
          
                - name: configure nginx
                  template: src=templates/nginx.conf.j2 dest=/etc/nginx/sites-available/test mode=0644
                  notify: restart nginx

                - name: delete old link
                  file: path=/etc/nginx/sites-enabled/default state=absent
                  notify: restart nginx

                - name: activate test site
                  file: src=/etc/nginx/sites-available/test dest=/etc/nginx/sites-enabled/test state=link
                  notify: restart nginx
              handlers:
                - name: restart nginx
                  service: name=nginx state=restarted
                  
                  
        ansible-playbook -K /home/user/ansiblework/playbook/loadbalancer.yml                    .....pokrenemo zadatke na loadbalancer-u    
        SUDO password: password                                                                      i unesemo password za logovanje na ubuntubalance mašinu
        
        
        
                  
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~VEŽBA 4~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
 
    
    
    *INVENTORY 
   
        mkdir lab-ansible && cd lab-ansible
         
        vim ansible.cfg
           [defaults]
           inventory = hosts
           host_key_checking = False
       
        vim hosts
           [privatelab]
           web
           db
           share

           [privatelab:vars]
           ansible_connection=ssh  
           ansible_user=vagrant 
           ansible_ssh_pass=passwordxy
           ansible_python_interpreter=python3
           
           
    *PLAYBOOK 1
    
        mkpasswd -m sha-512 abbccd246
        $6$y6V4M2tQGoEkG7$KNsZToQ7upfo9pN2Wbzk8tjfq5FRsftb2iNpXDnh51lgbsDq6F9nMb32hPStJvhheUBiG8j5Li.vLzsl.eKu50   
    
        vim privatelab-vagrant.yml                                                  .....kreiramo playbook fajl za vagrant korisnika kojim mu menjamo password
           ---                                                                           (dodajemo kriptovan) na svim mašinama, dodajemo SSH public key i 
           - hosts: all                                                                  instaliramo 4 programa
             become: 'yes'
             vars:
               user:
                 - name: "vagrant"
                   password: "passwordxy"
                   ssh_key: ".ssh/authorized_keys"
               packages:
                 - vim
                 - wget
                 - curl
                 - htop
             tasks:
               - name: Change password for default user
                 user:
                   name: "vagrant"
                   password: "$6$y6V4M2tQGoEkG7$KNsZToQ7upfo9pN2Wbzk8tjfq5FRsftb2iNpXDnh51lgbsDq6F9nMb32hPStJvhheUBiG8j5Li.vLzsl.eKu50"
                   state: present
                 loop:
                   - "{{ user}} "
               - name: Add SSH public key
                 authorized_key:
                   user: "vagrant"
                   key: "{{ lookup('file', '/home/user/.ssh/id_rsa.pub') }}"        
                 loop:
                   - "{{ user }}"
               - name: Ensure a list of packages installed
                 yum:
                   name: "{{ packages }}"
                   state: present
               - name: All done!
                 debug:
                   msg: Packages have been successfully installed           
          
        
        ansible-playbook privatelab.yml
  

    
    *PLAYBOOK 2 
    
        openssl passwd -6 bbcdd369
        $6$VGuKcM0V/UaHrtAU$FC8Jai1vu7T8RABUbGwfStvgteZc4TAKcmSmWPvBVR9L6fiK5qWRarj47dFh5r6efylZ4evpWi44ZgTCE3yvdf
        
        cd lab-ansible
    
        vim create-user-centbb.yml                                                  .....izrađujemo playbook fajl kojim kreiramo korisnika centbb i dodeljujemo                                                                                                                 
           ---                                                                           mu kriptovan password i druge atribute                  
           - name: Create centbb user
             hosts: all
             become: yes
             become_method: sudo
             vars:
               users:
               - username: centbb
                 password: $6$VGuKcM0V/UaHpwAU$FC8Jai1vu7T8RABUbGwfStvVVRZc4TAKcmSmWPvBVR9L6fiK5qWRarj47dFh5r6efylZ4evpWi44ZgTCE3yyl/ 
             tasks:
               - name: Create user centbb
                 user:
                     name: "{{ item.username }}"
                     shell: /bin/bash
                     createhome: yes
                     group: wheel
                     generate_ssh_key: yes
                     ssh_key_bits: 2048
                     password: "{{ item.password }}"
                     update_password: always
                 with_items: "{{ users }}"  
  
  
        ansible-playbook create-user-centbb.yml --syntax-check

        ansible-playbook create-user-centbb.yml
  
  
    **PLAYBOOK 3
    
        openssl passwd -6 1234                                                                                          .....kreiramo kriptovan password za cent1
        $6$NXTph6srFNx9tSVU$sMexfh.UqZDe6YFfx2nbRP..yxsSA.ShnpP6qaUIg.LbUjvmbPOpCy7a4H0q2Nit3QtLaSLLpp8X5L4bCAjur0
        
        openssl passwd -6 abcd                                                                                          .....kreiramo kriptovan password za cent2
        $6$Z3vfYNm/1BAWY1J0$g1HP1hStPYJWXKv8qqZHsF9CVRptUaw7Zxzn7lmwYrU8he75AAehQhOtPYHvWBuCtVlWcAnuITpEOKNW5Llzq1
        
        openssl passwd -6 1111                                                                                          .....kreiramo kriptovan password za cent3
        $6$Jd1VxozcrVT8KiiY$8iqL/btufdbsZC.tEXyB.19UujE35t8to5qF5SSCpnwW36wu6GrJTIHfr1y1Y6bH7GKVVbgyhX/RfYGvyzIRx/
        
        cd lab-ansible

        vim new-users.yml                                                           .....izrađujemo playbook fajl kojim kreiramo korisnike cent1, cent2 i cent3       
           ---                                                                           dodeljujemo im različite passworde, javne ključeve sa master mašine,  
           - hosts: "privatelab"                                                         određujemo im grupe i menjamo /etc/sudoers fajl dodavanjem linije kojom
             become: yes                                                                 menjamo privilegije članova admin grupe usera
             become_method: sudo
             connection: "local"
             vars:
               users:
               - username: "cent1"
                 groups: "apache"
                 password: $6$NXTph6srFNx9tSVU$sMexfh.UqZDe6YFfx2nbRP..yxsSA.ShnpP6qaUIg.LbUjvmbPOpCy7a4H0q2Nit3QtLaSLLpp8X5L4bCAjur0 
               - username: "cent2"
                 groups: "wheel"
                 password: $6$Z3vfYNm/1BAWY1J0$g1HP1hStPYJWXKv8qqZHsF9CVRptUaw7Zxzn7lmwYrU8he75AAehQhOtPYHvWBuCtVlWcAnuITpEOKNW5Llzq1
               - username: "cent3"
                 groups: "wheel,adm"
                 password: $6$Jd1VxozcrVT8KiiY$8iqL/btufdbsZC.tEXyB.19UujE35t8to5qF5SSCpnwW36wu6GrJTIHfr1y1Y6bH7GKVVbgyhX/RfYGvyzIRx/      
            tasks:
            - name: "Create user accounts"
              user:
                 name: "{{ item.username }}"
                 groups: "{{ item.groups }}"
                 generate_ssh_key: yes
                 ssh_key_bits: 2048
                 password: "{{ item.password }}"
                 update_password: always
              with_items: "{{ users }}"
            - name: "Add authorized keys"
              authorized_key:
                 user: "{{ item.username }}"
                 key: "{{ lookup('file', '/home/user/.ssh/id_rsa.pub') }}"
              with_items: "{{ users }}"
            - name: "Allow admin users to sudo without a password"
              lineinfile:
                 dest: "/etc/sudoers" 
                 state: "present"
                 regexp: "^%adm"
                 line: "%admin ALL=(ALL) NOPASSWD: ALL"   
    
    
    
    **PLAYBOOK 4
    
        vim remove-user.yml                                                         .....izrađujemo playbook fajl kojim brišemo korisnika cent3 sa svih mašina
           ---
           - hosts: "privatelab"
             become: yes
             become_method: sudo
             vars:
               remove_users:
               - "cent3"
             tasks:
             - name: "Remove user accounts in remove_users"
               user:
                 name: "{{ item }}"
                 state: "absent"
               with_items: "{{ remove_users }}"
       
    
    
    
    **PLAYBOOK 5
    
        vim new-pass.yml                                                  
           ---                                                                            
           - hosts: all                                                                  
             become: 'yes'
             vars:
               user:
                 - name: "cent2"
                   password: "abcd"
             tasks:
               - name: Change password for one user
                 user:
                   name: "cent2"
                   password: "$6$D.tdp7Hqcjg4BHde$pWeKTRsS1FzyKJLYv62DJCtcUL36hwG5Llfet5uvvw/ktcglG/w0LmQ2w/GpB5wmM76ilBnyQPZkuTIeg5kD01"
                   state: present
                 loop:
                   - "{{ user}} "
    
    