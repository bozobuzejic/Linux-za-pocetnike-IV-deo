KUBERNETES I MINIKUBE

Kubernetes (k8) je platforma koja se koristi za upravljanje radnim opterećenjima u kontejneru i automatizaciju usluga
(kubernetes je kontejner-sistem orkestracije za automatizaciju primene, skaliranja i upravljanja aplikacijama).
 
Upravljanje Kubernetes klasterom sa više čvorova (node-čvor), vrši master node a upravljani čvorovi su worker nodes 
(potreban je najmanje 1 glavni (master) server i 2 radna (workers) servera).
     
Minikube (minimalna verzija k8) je alat koji omogućuje pokretanje jednog klastera Kubernetesa na lokalnom računaru. 
     
Minikube pokreće lokalni kubernetes klaster s jednim čvorom unutar virtualne mašine, uz malo trošenje resursa 
(minikube virtuelnu mašinu u nekom hipervizoru - VirtualBox-u na primer). Idealan je za testiranje softvera. Minikube pakuje i konfigurše Linux Virtual Machine, instalira Docker i sve Kubernetesove komponente u njega.
     
Bazične kompomente minikube i kubernetes su:
     
        - Container:      Kontejneri su blok za građenje i kreiranje aplikacija. Kontejner je softverski skup paketa i programskih zavisnosti za pokretanje 
                          neke aplikacije 
        
        - Pod:            Pod je zbir jednog ili više kontejnera-spremnika koji dele skladište podataka (storage) i mrežne resurse, određuje način kako se
                          pokreću kontejneri u minikubeu
                          Pod upravlja grupom jednog ili više kontejnera raspoređenih na radnom čvoru (node) kubernetes klastera 
                          Kubernetes klasteri mogu imati više pod-ova i svaki pod ima jedinstvenu IP adresu za povezivanje
                          Primer: Ako definišemo 2 pod-a, a tokom rada dođe do pada jednog pod-a, minikube automatski aktivira drugi pod (ljusku) 
                          
                          
        - Service:        Servisi su sloj koji obezbeđuje da interakcija između različitih pod-ova na klasteru funkcioniše bez zastoja (ako dođe do pada jednog 
                          pod-a, pokreće se drugi pod automatski)
                          Omogućuju i pristup aplikacijama i kontejnerima izvan mreže klastera
              
        - Master:         Master je mašina kubernetes klastera koja koordinira rad klastera, upravlja operacijama na klasteru  
        
        - Node:           Čvorovi (nodes) su radne mašine klastera koje pokreću kontejnere i aplikacije (koji su složeni u pod-ove)
                          Čvor može biti virtualna mašina ili fizički server
                          Na svim čvorovima se instalira i pokreće docker 
        
        - Deployment:     Deployment-raspoređivanje-implementacija fajlova je skup uputstava za kreiranje pod-ova i drugih elemenata za rad aplikacije
                          Fajlovi koji se implementiraju su slični docker-compose fajlovima iz Docker okruženja 
                          Deployment nadzire klaster i održava definisane specifikacije za Pod-ove (ako se izbriše neki pod, konfigurisana implementacija 
                          kreira novu strukturu kako je definisano u fajlu)
        
        - Kubectl:        Kubectl je komandna linije za upravljanje okruženjem klastera, sve operacije u klasteru se izvršavaju iz komandne linije kubectl
                          (kubectl služi za interakciju s klasterom) 
        
        Pod uvek radi na čvoru (node). Node je radna mašina (worker) u kubernetesu, virtuelna ili fizička, zavisno od klastera. Svakim čvorom upravlja master.
        Čvor može imati više pod-ova, a kubernetesova master mašina automatski raspoređuje pod-ove preko čvorova u klasteru. Prilikom automatskog raspoređivanja, 
        master vodi računa o raspoloživim resursima na svakom čvoru.
       
       
      
    
    *Instaliranje hipervizora za virtualizaciju:
    
     egrep -c '(vmx|svm)' /proc/cpuinfo                                                                .....proverimo da li CPU podržava hardversku virtualizaciju
                                                                                                            (ako je odgovor 0, onda ne podržava); na samomom
                                                                                                            računaru je potrebno da bude virtuelizacija omogućena u 
                                                                                                            BIOS-U
                                                                                                            
     sudo apt install virtualbox virtualbox-ext-pack                                                   .....instaliramo virtalbox i extension pack za VirtualBox
     ili
     sudo apt -y install qemu-kvm libvirt-daemon libvirt-daemon-system virtinst bridge-utils           .....instaliramo neophodne pakete za QEMU/KVM konekciju na
                                                                                                            Virtual Machine Manageru
     
     
MINIKUBE
     
    *Instaliranje docker-a:
     
     sudo apt-get install docker-ce docker-ce-cli containerd.io                                        .....instaliramo docker (pogledati poglavlje  *DOCKER)
     systemctl start docker
     systemctl enable docker                                                                           .....starujemo i omogućimo docker
     docker --version                                                                                  .....prikažemo verziju docker-a
     Docker version 20.10.5, build 55c4c88
     sudo groupadd docker                                                                              .....kreiramo docker grupu i dodajemo joj aktuelnog korisnika
     sudo usermod -aG docker ${USER}                                              
     
     
    *Instaliranje minikube:
     
     wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64                 .....preuzimamo najnoviju verziju Minikube biblioteke
     sudo cp minikube-linux-amd64 /usr/local/bin/minikube                                              .....kopiramo binarni, izvršni fajl u /usr/local/bin folder
     sudo chmod +x /usr/local/bin/minikube                                                             .....dodamo execute permissions fajlu minikube
     ili
     chmod 755 /usr/local/bin/minikube
     minikube version                                                                                  .....izlistamo verziju minikube:
     minikube version: v1.18.1
     commit: 09ee84d530de4a92f00f1c5dbc34cead092b95bc

     
    *Instaliranje  kubectl:
     
     Napomena: Instaliranje kubectl na način iz Verzije 1. funkcioniše ako se minikube pokreće sa Docker driver-om  a iz Verzije 2. je neophodno ako se pokreće 
               sa virtualbox driver-om   
     
     Verzija 1.
     
     sudo -i
     curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
     echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" | tee /etc/apt/sources.list.d/kubernetes.list   .....dodamo kubectl repository na sources listu OS
     apt-get update -y                                                                                           .....izvršimo update sistema
     apt-get install kubectl kubeadm kubectl -y                                                                  .....instaliramo potrebne kubectl alate
     
     ili
     
     Verzija 2.
     
     curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl        .....instaliramo kubectl tool (Kubectl je Kubernetes command-line alat koji omogućuje izvršavanje komandi u Kubernetes klasteru) 
     
     sudo chmod +x ./kubectl                                                                           .....binarni fajl učinimo izvršnim
     sudo mv ./kubectl /usr/local/bin/kubectl                                                          .....premestimo binary fajl u /usr/local/bin folder

    
     kubectl version -o yaml                                                                           .....proverimo verziju kubectl alata 

     ~/.minikube/machines/minikube/config.json                                                         .....konfiguracioni fajl minikube-a

     

     ~ a. Pokretanje minikube sa docker driver-om (kad imamo instaliran docker)
     
     minikube start --vm-driver=docker         .....pokrenemo minikube sa docker driver-om
     
     ili
     
     minikube config set driver docker         .....podesimo da se minikube čvor uvek pokreće sa docker driver-om
     minikube start                            .....pokrenemo minikube: komanda automatski selektuje docker driver, preuzima boot image virtuelne mašine i kreira 
                                                    Kubernetes klaster sa single node-om (čvorom - virtuelnom mašinom) i dobijemo izlaz: 
     😄  minikube v1.18.1 on Debian 10.9
     ✨  Automatically selected the docker driver. Other choices: virtualbox, none, ssh     .....pored docker drivera možemo birati i virtualbox, none ili ssh
     👍  Starting control plane node minikube in cluster minikube                                driver
     🔥  Creating docker container (CPUs=2, Memory=2200MB) ...
     🐳  Preparing Kubernetes v1.20.2 on Docker 20.10.3 ...
     .....
     
     
     
     ~ b. Pokretanje minikube sa virtualbox driver-om (kad imamo instaliran virtualbox)
     
     minikube start --vm-driver=virtualbox     .....pokrenemo minikube sa virtualbox driver-om
     😄  minikube v1.18.1 on Debian 10.9
     ✨  Using the virtualbox driver based on user configuration
     👍  Starting control plane node minikube in cluster minikube
     🔥  Creating virtualbox VM (CPUs=2, Memory=2200MB, Disk=20000MB) ...
     .....
     
     ili
     
     minikube config set driver virtualbox     .....podesimo da se minikube čvor pokreće sa virtualbox driver-om 
     minikube start                            .....pokrenemo minikube: komanda automatski selektuje virtualbox driver, preuzimamo boot image virtuelne mašine 
                                                    koja se pojavljuje na komandnoj tabli VirtualBox-a kao minikube mašina
                                                    
     minikube stop                             .....zaustavimo mašinu minikube na VirtualBox-u kako bi se promenika podešavanja procesora na mašini minikube
                                                    u VirtualBox-u:
     VirtualBox -> minikube -> Settings -> Sytem -> Processor -> čekirati Extended features: Enable Nasted VT-x/AMD-V -> OK  
     .....eksplicitno izaberemo naznačenu opciju koja obezbeđuje bolje performanse uz prosleđivanje funkcija hardverske virtualizacije na gostujuću VM                                              
                                                    
     
     
     ~ c. Pokretanje minikube sa KVM driver-om (kad imamo instaliran QEMU/KVM)
     
     wget https://storage.googleapis.com/minikube/releases/latest/docker-machine-driver-kvm2           .....preuzmemo docker-machine-driver-kvm2
     sudo chmod 755 minikube docker-machine-driver-kvm2                                                .....dodamo izvršnu funkciju fajlu docker-machine-driver-kvm2
     sudo mv minikube docker-machine-driver-kvm2 /usr/local/bin/
     
     minikube start --vm-driver kvm2           .....pokrećemo minikube na Virtual Machine Manager (QEMU/KVM)
     😄  minikube v1.19.0 on Debian 10.9
     ✨  Using the kvm2 driver based on user configuration
     👍  Starting control plane node minikube in cluster minikube
     🔥  Creating kvm2 VM (CPUs=2, Memory=2200MB, Disk=20000MB) ...
     .....
     
            
    *Upravljanje minikube mašinom i izlistavanje statusa i konfiguracija:
     
     
     minikube ssh                                                                            .....povežemo se sa minikube Virtuelnom Mašinom u VirtualBox-u

     exit                                                                                    .....raskidamo ssh vezu sa VM minikube

     minikube stop                                                                           .....isključujemo VM minikube klaster

     minikube delete                                                                         .....izbrišemo lokalni kubernetes klaster (brišemo
                                                                                                  minikube VM iz VB)
                                                                
     minikube status                                                                         .....izlistamo status minikube
     minikube
     type: Control Plane
     host: Running
     kubelet: Running
     apiserver: Running
     kubeconfig: Configured
     timeToStop: Nonexistent

     
     kubectl get nodes                                                                       .....izlistamo sve čvorove (node) - imamo jedan čvor koji je spreman 
     NAME       STATUS   ROLES                  AGE   VERSION                                     za implementaciju klastera 
     minikube   Ready    control-plane,master   28m   v1.20.2

     
     ~~ a. Kad je minikube pokrenut sa docker driver-om 
     
     kubectl cluster-info                                                                                       .....izlistamo informacije o statusu klastera
     Kubernetes control plane is running at https://192.168.49.2:8443                                           .....ip adresa u mreži koju kreira docker driver
     KubeDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy   
    
    
     ~~ b. Kad je minikube pokrenut sa virtualbox driver-om
     
     kubectl cluster-info
     Kubernetes control plane is running at https://192.168.99.114:8443                                         .....ip adresa u mreži koju kreira virtualbox driver
     KubeDNS is running at https://192.168.99.114:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy 

     
     ~~ c. Kad je minikube pokrenut sa  KVM driver-om
     
     kubectl cluster-info
     Kubernetes control plane is running at https://192.168.39.213:8443
     KubeDNS is running at https://192.168.39.213:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy



     kubectl config view                                                                     .....pregledamo zadatu konfiguraciju kubectl-a

     minikube addons list                                                                    .....pregledamo sve dodatke za minikube
     
     kubectl get pods --all-namespaces                                                       .....pregledamo sve slike kontejnera koji se izvode u klasteru

     
     
    *Kontrolna tabla (resursima u klasteru se upravljaa i sa nadzone table)
    
     minikube dashboard                                                                      .....aktiviramo komandu za pokretanje komandne tablu 
     ...                                                                                          u web pretraživaču i dobijemo izlaz:
     Opening http://127.0.0.1:44271/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ in your default browser...
     Opening in existing browser session. ->
     -> stranica komandne table se automatski otvara u web browseru                                                   
      
     ili
      
     minikube dashboard --url                                                                .....ako izdamo komandu sa dodatkom --url dobijamo izlaz:
     http://127.0.0.1:39259/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/     
     
     Web browser -> http://127.0.0.1:39259/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ -> priključujemo se na web dashboard
     
     
    *Primer 1: Kreiranje klastera - postavljanje jednostavnog http servera 
    
     Kreiranje klastera:

     kubectl create deployment hello-minikube --image=k8s.gcr.io/echoserver:1.10          .....kreiramo Kubernetesovu implementaciju hello-minikube koristeći 
                                                                                               postojeću sliku echoserver (jednostavan HTTP server s portom 8080)
     kubectl expose deployment hello-minikube --type=NodePort --port=8080                 .....pristupamo implementaciji hello-minikube i specifikujemo uslugu              
                                                                                               (NodePort - dodeljuje svakom čvoru port što omogućuje pristup 
                                                                                               čvorovima izvan klastera) 

     Provera implementacije:

     kubectl get deployments                                                              .....proveravamo implementaciju
     NAME      READY   UP-TO-DATE   AVAILABLE   AGE
     hello-minikube   1/1     1            1           6m54s

     kubectl get services                                                                 .....daje prikaz hello-minikube kao servisa 
     NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
     hello-minikube  NodePort    10.103.252.30   <none>        8080:32088/TCP  7m24s
     kubernetes      ClusterIP   10.96.0.1       <none>        443/TCP         4h52m

     kubectl get pods                                                                     .....daje popis svih pod-ova (hello-minikube postaje 
     NAME                              READY   STATUS    RESTARTS   AGE                        hello-minikube-5d9b964bfb-wlxdn 
     hello-minikube-5d9b964bfb-wlxdn   1/1     Running   0          28m                                         
     
     minikube service hello-minikube --url                                                .....izlista ip adresu servisa hello-minikube
     http://192.168.39.213:32088
     Web browser -> http://192.168.39.213:32088 -> Hostname: hello-minikube-5d9b964bfb-wlxdn...     .....proba na web browseru

     
     Konekcija na ljusku (pod):
     
     kubectl exec -it hello-minikube-5d9b964bfb-wlxdn -- bash                             .....konektujemo se na pod hello-minikube-5d9b964bfb-wlxdn preko 
                                                                                               shell-a bash
     root@hello-minikube-5d9b964bfb-wlxdn:/# 
     exit                                                                                      .....izlazimo iz "mašine"

     
     Brisanje implementacije:
     
     kubectl delete services hello-minikube                                               .....izbrišemo servis hello-minikube

     kubectl delete deployment hello-minikube                                             .....izbrišemo implementaciju hello-minikube

     kubectl delete pod hello-minikube                                                    .....izbrišemo implementaciju hello-minikube
    
    
    
    
    *Primer 2: Kreiranje klastera - postavljanje NGINX servera na minikube
    
     
     kubectl create deployment mynginx --image=nginx                                   .....kreira pravila za implementaciju pod-a mynginx na slici nginx aplikacije
     
     kubectl get pods                                                                  .....daje popis svih pod-ova
     
     kubectl exec mynginx env                                                          .....izvršava okruženje mynginx-a                       
     
     kubectl exec -it mynginx -- bash                                                  .....izvršava mynginx u bash-u - konektujemo se na pod kao na 
                                                                                            virtuelnu mašinu
            kubectl scale deployment mynginx --replicas=3                                   .....alternativno kreiramo 3 replike na koje će se raspoređivati 
            kubectl get pods                                                                     resursi
                                     
     kubectl expose deployment mynginx --type="NodePort" --port 80                     .....izlaže (expose) implementaciju mynginx na portu 80 preko NodePort usluge
     
     kubectl get services mynginx                                                      .....daje prikaz mangix kao servisa                                           
     
     
     minikube service mynginx --url                                                    .....izlista ip adresu servisa mynginx                                
     
     Web browser -> http://192.168.39.84:31459 -> Welcome to nginx!                    .....proba na web browseru  
     
     
     kubectl port-forward service/mynginxapp 7080:80                                   .....forvarduje port 80 na port 7080 i omogući pristup sa spoljne mreže
     
     Web browser -> http://localhost:7080 -> Welcome to nginx!
     
     
     
     
    *Primer 3: Kreiranje klastera - kompletna procedura kreiranja minikube čvora na QEMU/KVM hipervizoru sa postavljanjem NGINX implementacije
                (instaliranje i konfigurisanje Minikube klastera unutar virtualne mašine uz primenu Docker Container Orchestration System-a)
     
     Instalacija KVM hipervizora za virtualizaciju:
     
     egrep -c '(vmx|svm)' /proc/cpuinfo                                                                .....proverimo da li CPU podržava hardversku virtualizaciju
     2
     sudo apt -y install qemu-kvm libvirt-daemon libvirt-daemon-system virtinst bridge-utils           .....instaliramo bitne KVM pakete
     sudo  apt -y install apt-transport-https gnupg2 curl                                              .....instaliramo i druge potrebne pakete
     
     
     Instaliranje i konfiguracija minikube i kubectl sa kvm driver-om
    
     sudo -i
     curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -                                 .....povučemo sigurnosni ključ
     echo "deb http://apt.kubernetes.io/ kubernetes-xenial main" | tee -a /etc/apt/sources.list.d/kubernetes.list  .....dodamo link ka repozitorijumu u listu izvora
     apt update
     apt -y install kubectl                                                                                        .....instaliramo kubectl komandnu liniju
     ctrl + D
     
     wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 -O minikube     .....preuzmemo minikube 
     wget https://storage.googleapis.com/minikube/releases/latest/docker-machine-driver-kvm2           .....preuzmemo docker-machine-driver-kvm2
     sudo chmod 755 minikube docker-machine-driver-kvm2                                                .....dodamo izvršnu funkciju fajlu docker-machine-driver-kvm2
     sudo mv minikube docker-machine-driver-kvm2 /usr/local/bin/
     
     
     Izlistavanje verzije, statusa i drugih podataka o minikube klasteru:
     
     minikube version                                                                                       
     kubectl version -o json                                                                           .....izlistamo podatke o verziji minikube i kubectl                                                                      
     
     minikube start --vm-driver kvm2                                                                   .....pokrećemo minikube na Virtual Machine Manager (QEMU/KVM)
     
     minikube status
     minikube service list
     minikube docker-env                                                                               .....izlistamo status minikube, listu servisa i elemente
                                                                                                            okruženja
     kubectl cluster-info                                                                              .....izlistamo informacije o http adresi klastera
     Kubernetes control plane is running at https://192.168.39.84:8443
     KubeDNS is running at https://192.168.39.84:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

     kubectl get nodes
     kubectl config view
     minikube addons list
     kubectl get pods --all-namespaces                                                                  .....izlistamo čvorove, konfiguraciju, listu dodataka 
                                                                                                             i pod-ova
     
     minikube ssh                                                                                       .....konektujemo se na minikube mašinu 
        $ whoami
        docker
        $ hostname
        minikube
        $ exit
        logout
     
     minikube dashboard                                                                                 .....pokrenemo komandnu tablu na web browseru,
                                                                                                             sve što instaliramo, konfigurišemo, dodajemo o
                                                                                                             brišemo, biće prikazano na kontrolnoj tabli
                                                                                                             
     minikube stop
     minikube delete                                                                                    .....zaustavimo i izbrišemo minikube mašinu
     
     
    *Kreiranje (i brisanje) pod-ova
     
     kubectl create deployment test-nginx --image=nginx                                                 .....kreiramo implementaciju test-nginx pods
     deployment.apps/test-nginx created
     
     kubectl get pods                                                                                   .....pogledamo spisak pod-ova (implementacija test-nginx
     NAME                         READY   STATUS              RESTARTS   AGE                                 je test-nginx-59ffd87f5-dcfw2 pod)
     test-nginx-59ffd87f5-dcfw2   0/1     ContainerCreating   0          44s
     
     kubectl exec test-nginx-59ffd87f5-dcfw2 -- env                                                     .....prikazujemo varijable okruženja test-nginx pod
     PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
     HOSTNAME=test-nginx-59ffd87f5-dcfw2
     KUBERNETES_SERVICE_PORT=443
     KUBERNETES_SERVICE_PORT_HTTPS=443
     KUBERNETES_PORT=tcp://10.96.0.1:443
     KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
     KUBERNETES_PORT_443_TCP_PROTO=tcp
     KUBERNETES_PORT_443_TCP_PORT=443
     KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
     KUBERNETES_SERVICE_HOST=10.96.0.1
     NGINX_VERSION=1.19.9
     NJS_VERSION=0.5.3
     PKG_RELEASE=1~buster
     HOME=/root

     kubectl exec -it test-nginx-59ffd87f5-dcfw2 -- bash                         .....konektujemo se na test-nginx pod sa bash shell-om                               
     root@test-nginx-59ffd87f5-dcfw2:/# hostname
     test-nginx-59ffd87f5-dcfw2
     exit
     
     kubectl logs test-nginx-59ffd87f5-dcfw2                                     .....prikazuje podatke iz log fajla za test-nginx pod
     
     kubectl scale deployment test-nginx --replicas=3                            .....proširuje implementaciju test-nginx na 3 replike (tako da dobijemo tri pod-a)
     deployment.apps/test-nginx scaled
     
     kubectl get pods                                                            .....izlistamo sve pod-ove
     NAME                         READY   STATUS    RESTARTS   AGE
     test-nginx-59ffd87f5-2bwwv   1/1     Running   0          46s
     test-nginx-59ffd87f5-dcfw2   1/1     Running   0          13m
     test-nginx-59ffd87f5-dzgth   1/1     Running   0          46s

     kubectl expose deployment test-nginx --type="NodePort" --port 80            .....izlažemo implementaciju test-nginx preko usluge NodePort koja dodeljuje            
     service/test-nginx exposed                                                       svakom čvoru (node) port što omogućuje pristup čvorovima izvan klastera)
                                                                                               
     
     kubectl get services test-nginx                                             .....izlistamo podatke tza test-nginx servis
     NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
     test-nginx   NodePort   10.110.100.31   <none>        80:31459/TCP   37s
     
     minikube service test-nginx --url                                           .....prikažemo url adresu test-nginx pod-a
     http://192.168.39.84:31459
     
     curl http://192.168.39.84:31459                                             .....proverimo da li nginx servis radi na pod-u test-nginx na terminalu 
     ili                                                                              ili u web browser-u
     Web browser -> http://192.168.39.84:31459 -> Welcome to nginx!

     kubectl delete services test-nginx                                          .....brišemo servis
     kubectl delete deployment test-nginx                                        .....brišemo imlementacju
     kubectl delete pod test-nginx
     
     
     
     
KUBERNETES

Sve navedeno je rađeno na virtuelnim mašinama ubuntu-18.04.5 i ubuntu-20.04.2 server mašinama u VirtualBox-u

    *VirtualBox: Konfigurisanje mreže 
     
    1. Open VB -> File -> Host Network Manager -> Create -> vboxnet1
    2. Configure Adapter Manually -> ipv4 -> 192.168.99.1/24 -> ipv4 Networkmask: 255.255.255.0
    3. DHCP server: 192.168.99.100 -> Server Mask: 255.255.255.0 -> Lower address bound: 192.168.99.101 -> Upper address bound: 192.168.99.120
    
    *Instaliranje virtuelne mašine - base: ubuntu-20.04.2-live-server-amd64.iso 

    1. Open VB New ->  ubuntu20 -> Next ---> Memory size: 4096MB -> Next ---> Create -> Next ---> Next ---> Create a virtual hard disk now -> Create -> 
       -> VDI -> Next ---> Dynaimically Allocated -> Next ---> 20GB -> Create 
    2. ubuntu18 -> Settings -> Network - Adapter 1 -> Enable network adapter; Attached to: Nat -> Advanced: iskopirati MAC Address -> OK
    3.          -> Settings -> Network - Adapter 2 -> Enable network adapter; Attached to: Host-only Adapter -> Name: vboxnet1 - > OK
    4.          -> Settings -> Storage -> Chose virtual optical disk file -> ubuntu-18.04.5-live-server-amd64.iso -> OK
    5. ubuntu18 -> Start -> ubuntu18    --->>>  propratiti instalaciju do kraja  ---->>>  reboot    

    
    *Podešavanje virtuelne mašine -base: ubuntu18      

      sudo apt-get update                                                                           .....ažuriramo sistem
     
     
      sudo mv /etc/netplan/00-installer-config.yaml /etc/netplan/00-installer-config.yaml.orig      .....sačuvamo originalni konfiguracioni fajl
      
      sudo vim /etc/netplan/50-cloud-init.yaml                                                      .....kreiramo novi konfiguracioni fajl za enp0s3 adapter (NAT)                                                    
              network:
                  ethernets:
                      enp0s3:
                          dhcp4: true
                          match:
                              macaddress: 08:00:27:98:d5:30                                              .....upisati mac adresu Adapter-a 1 (NAT)                             
                          set-name: enp0s3
                  version: 2

      sudo netplan apply                                                                            .....ažuriramo promenu ip adrese 
     
      sudo sed -i -e 's/#DNS=/DNS=8.8.8.8/' /etc/systemd/resolved.conf                              .....u fajlu /etc/systemd/resolved.conf menjamo red #DNS=
                                                                                                         u red DNS=8.8.8.8 kako bi se omogućio pristup
                                                                                                         google-ovom DNS serveru
      sudo vim /etc/hosts                                                                           .....unesemo izmene u /etc/hosts kako bi se mašine međusobno
              ff02::3 ip6-allhosts                                                                       prepoznavale 
              192.168.99.31 kubemaster
              192.168.99.32 worker1
              192.168.99.33 worker2
             
      
     Varijanta 1:______________________________________________
                                                               
      sudo apt-get install containerd -y                                                            .....instaliramo containerd daemon (kad nećemo da koristimo
      mkdir -p /etc/containerd                                                                           Docker servis)
      containerd config default  /etc/containerd/config.toml   
     __________________________________________________________ 
      
      
                               ili
    
     Varijanta 2:______________________________________________
                                                            
      sudo apt install -y docker.io                                                            .....instaliramo docker servis, dodamo grupu docker, grupi dodamo 
      sudo groupadd docker                                                                          trenutnog korisnika sistema                                                                  
      sudo usermod -aG docker ${USER}                          
                                                              
      cat > /etc/docker/daemon.json <<EOF                                                      .....kreiramo /etc/docker/daemon.json fajl kojim menjamo           
      {                                                                                             upravljački program grupe Docker iz cgroupdriver u systemd  
        "exec-opts": ["native.cgroupdriver=systemd"],                                               kako bi kontrolisali memorijski resursi računara
        "log-driver": "json-file",                                                              
        "log-opts": {
          "max-size": "100m"
        },
        "storage-driver": "overlay2"
      }
      EOF
    
      sudo systemctl enable docker --now                                                       .....omogućimo docker i pokrenemo ga
     ___________________________________________________________ 
    
     
      sudo -i
     
      swapoff -a
      vim /etc/fstab 
         #/swap.img	none   swap   sw   0   0                                                   .....zakomentarišemo liniju i onemogućimo swap kako ne bi došlo zbog 
                                                                                                    konflikta zbog kontrole memorisjkog prostora
         
     
      apt-get update &&  apt-get install -y apt-transport-https gnupg2 curl                    .....instaliramo potrebne alate ako ih nemamo
      curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -       .....instaliramo GPG ključ za Kubernetes 
      
      echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" |  tee -a /etc/apt/sources.list.d/kubernetes.list  .....dodamo repository fajl za Kubernetes
                                                                                                                           za ubuntu 18.04
      ili
      
      echo "deb https://apt.kubernetes.io/ kubernetes-focal main" |  tee -a /etc/apt/sources.list.d/kubernetes.list   .....dodamo repository fajl za Kubernetes
                                                                                                                           za ubuntu 20.04
      apt-get update                                                                                                  .....ažuriramo sistem
     
      apt-get install -y kubelet kubeadm kubectl                                                                      .....instaluramo Kubernetes alate
      
      systemctl enable kubelet.service --now                                                                          .....omogućimo i pokrenemo kubelet servis
     
      __________________________________________________________
      
      vim /etc/sysctl.d/k8s.conf                                                               .....kreiramo fajl kojim podesimo da se za prenos paketa premoste  
      net.bridge.bridge-nf-call-ip6tables = 1                                                       pravila iptables
      net.bridge.bridge-nf-call-iptables = 1

      modprobe overlay
      modprobe br_netfilter                                               
      echo 1 > /proc/sys/net/bridge/bridge-nf-call-iptables
      echo 1 > /proc/sys/net/ipv4/ip_forward
      
      sysctl --system                                                                          .....ponovo učitamo podešavanja svih sistemskih konfiguracionih 
                                                                                                    fajlova
      service systemd-resolved restart                                                         .....restartujemo systemd servis
      __________________________________________________________
      
      ili
      __________________________________________________________
      
      sudo vim /etc/sysctl.conf                                                                .....u /etc/sysctl.conf fajlu podesimo da se za prenos paketa omogući   
              net.ipv4.ip_forward=1                                                                 prosleđivanje paketa i premoste pravila iptables
              net.bridge.bridge-nf-call-iptables=1                    
      __________________________________________________________
                                                                                              
     
      apt-get install bash-completion                                                          .....inataliramo i podesimo bash-completion za kubectl automatsko  
      echo 'source <(kubectl completion bash)' >>~/.bashrc                                          dovršavanje
      kubectl completion bash >/etc/bash_completion.d/kubectl
      
      
      poweroff                                                                                 .....završimo sesiju na virtuelnoj mašini
     

    *Kloniranje  virtuelne mašine - base (full clone) u: ubuntu18kubemaster, ubuntu18worker1, ubuntu18worker2
    
    1. ubuntu18 -> desni klik: Clone -> Name: ubuntu18kubemaster -> Next -> Full clone -> Clone ->
       -> ubuntu18kubemaster -> Setting ->  
       -> System -> Motherboard -> Base memory: 4096 -> Processor: 2 cpu -> Extended Features: čekirati Eanble PAE/NX -> 
       -> Network - Adapter 1 -> Enable network adapter; Attached to: Nat -> Advanced -> Port forwarding -> Adds new port forwarding rule: 
          Name: ssh    Protocol: TCP    Host IP:127.0.0.1     Host port: 2222     Guest IP:     Guest Port: 22     -> OK -> OK
         
    2. ubuntu18 -> desni klik: Clone -> Name: ubuntu18worker1 -> Next -> Full clone -> Clone ->
       -> ubuntu18worker1 -> Setting -> 
       -> System -> Motherboard -> Base memory: 1024 -> Processor: 1 cpu -> Extended Features: čekirati Eanble PAE/NX -> 
       -> Network - Adapter 1 -> Enable network adapter; Attached to: Nat -> Advanced -> Port forwarding -> Adds new port forwarding rule: 
          Name: ssh    Protocol: TCP    Host IP:127.0.0.1     Host port: 2200     Guest IP:     Guest Port: 22     -> OK -> OK
       
    3. ubuntu18 -> desni klik: Clone -> Name: ubuntu18worker2 -> Next -> Full clone -> Clone ->  
       -> ubuntu18worker2 -> Setting -> 
       -> System -> Motherboard -> Base memory: 1024 -> Processor: 1 cpu -> Extended Features: čekirati Eanble PAE/NX -> 
       -> Network - Adapter 1 -> Enable network adapter; Attached to: Nat -> Advanced -> Port forwarding -> Adds new port forwarding rule: 
          Name: ssh    Protocol: TCP    Host IP:127.0.0.1     Host port: 2201     Guest IP:     Guest Port: 22     -> OK -> OK
 
 
    *Podešavanje virtuelne mašine: ubuntu18kubemaster 
      
     
      sudo vim /etc/netplan/50-userubuntu.yaml                                                 .....kreiramo novi konfiguracioni fajl za enp0s8 adapter (vboxnet1)  
              ---                                                                                   kako bi smo dobili statičku ip adresu mašine
              network:
                version: 2
                renderer: networkd
                ethernets:
                  enp0s8:
                    addresses:
                    - 192.168.99.31/24



      sudo netplan apply                                                                       .....ažurirati promenu ip adrese  
       
      sudo hostnamectl set-hostname "kubemaster"                                               .....preimenujemo host u kubemaster
      
      sudo vim /etc/hosts                                                                      .....u /etc/hosts fajl dodamo navedeni red 
              127.0.0.1   kubemaster kubemaster.local
         
        
      sudo reboot                                                                              .....restartujemo kubemaster mašinu
      
      
      sudo kubeadm init --apiserver-advertise-address 192.168.99.31 --pod-network-cidr=10.244.0.0/16      .....iniciramo klaster na kubemaster mašini (ako se 
                                                                                                               pojave upozorenja o greškama dodamo na kraj naredbe 
                                                                                                               --ignore-preflight-errors=all) i dobijemo izlaz:
      kubeadm join 192.168.99.31:6443 --token 2w2bhj.c9jplb6mpr7mgjz6 \
      --discovery-token-ca-cert-hash sha256:8054fa89a15d5dc71a5478a8f9dcd6b9932ba8abfd06f2303613e0387e56d22b
      
      kubeadm token list
      TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
      2w2bhj.c9jplb6mpr7mgjz6   23h         2021-04-18T21:56:10Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
      .....izlistamo token
      
      mkdir -p $HOME/.kube                                                                     .....shodno uputstvu koje dobijemo kad iniciramo klaster,
      sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config                                      kreiramo folder .kube, u njega iskopiramo admin.conf fajl i 
      sudo chown $(id -u):$(id -g) $HOME/.kube/config                                               promenimo vlasništvo na tom fajlu (userubuntu)
      ili
      export KUBECONFIG=/etc/kubernetes/admin.conf                                                        
                                                                                                               
      
      sudo kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml    .....dodajemo flanel mrežni dodatak za 
                                                                                                                           komunikaciju pod-ova na klasteru 
      
      
      sudo vim /etc/kubernetes/manifests/kube-scheduler.yaml                                  .....da bi smo dobili healthy (zdrav) planer zadataka 
              - -- port=0                                                                          izbrišemo datu liniju
      sudo vim /etc/kubernetes/manifests/kube-controller-manager.yaml                         .....da bi smo dobili healthy (zdrav) kontrol-menadžer
              - -- port=0                                                                          izbrišemo datu liniju
                                                             
      sudo systemctl restart kubelet.service                                                  .....restartujemo kubelet servis
      
      kubectl get cs                                                                          .....ispitamo healthy (zdravlje) kontrolnog mehanizma
      
      
      kubectl taint nodes --all node-role.kubernetes.io/master-                               .....možemo dodeliti glavnom čvoru - masteru ulogu radnog čvora
      
      

    *Podešavanje virtuelne mašine: ubuntu18worker1      
      
      sudo vim /etc/netplan/50-userubuntu.yaml                                                .....kreiramo novi konfiguracioni fajl za enp0s8 adapter (vboxnet1)
              ---                                                                                  kako bi smo dobili statičku ip adresu mašine
              network:
                version: 2
                renderer: networkd
                ethernets:
                  enp0s8:
                    addresses:
                    - 192.168.99.32/24

      sudo netplan apply                                                                      .....ažurirati novu ip adresu              

      sudo hostnamectl set-hostname "worker1"                                                 .....preimenujemo host u worker1
      
      sudo vim /etc/hosts                                                                     .....dodamo liniju u hosts fajl
              127.0.0.1   worker1 worker1.local
      
      sudo reboot                                                                             .....restartujemo mašinu
      
      sudo -i
      
      kubeadm join 192.168.99.31:6443 --token 2w2bhj.c9jplb6mpr7mgjz6 \
      --discovery-token-ca-cert-hash sha256:8054fa89a15d5dc71a5478a8f9dcd6b9932ba8abfd06f2303613e0387e56d22b        .....nalepimo snimljeni token

      

    *Podešavanje virtuelne mašine: ubuntu18worker2      
      
      sudo vim /etc/netplan/50-userubuntu.yaml                                                .....kreiramo novi konfiguracioni fajl za enp0s8 adapter (vboxnet1)
              ---                                                                                  kako bi smo dobili statičku ip adresu mašine
              network:
                version: 2
                renderer: networkd
                ethernets:
                  enp0s8:
                    addresses:
                    - 192.168.99.32/24

 
      sudo netplan apply                                                                      .....ažuriramo novu ip adresu              

      sudo hostnamectl set-hostname "worker2"                                                 .....preimenujemo host u worker2
      
      sudo vim /etc/hosts                                                                     .....dodamo liniju u hosts fajl
              127.0.0.1   worker2 worker2.local      
    
      sudo reboot                                                                             .....restartujemo mašinu
      
      sudo -i
      
      kubeadm join 192.168.99.31:6443 --token 2w2bhj.c9jplb6mpr7mgjz6 \
      --discovery-token-ca-cert-hash sha256:8054fa89a15d5dc71a5478a8f9dcd6b9932ba8abfd06f2303613e0387e56d22b        .....nalepimo snimljeni token



    **Podešavanje virtuelne mašine: ubuntu18kubemaster      
      
      *Kreiranje inicijalizacije, pod-a, nginx slike i pokretanje servisa webserver:
       
       kubectl create deployment nginx --image=nginx --port 80
       kubectl create deployment webserver --image=nginx --port 80 --replicas=5
       kubectl expose deployment webserver --port 80 --type=NodePort
       kubectl taint nodes --all node-role.kubernetes.io/master-                              .....podešavanje glavnog čvora da radi kao radni čvor
      
      *Izlistavanje osobina pojedinih elemenata kubernetes-a:
     
       kubectl -n kube-system get cm kubeadm-config -o yaml                                   .....izlistamo konfiguraciju klastera
       kubectl get deployments.apps
       kubectl get deployments.apps  -o wide
       kubectl get service
       kubectl get pods
       kubectl get pods --show-labels |egrep 'app=webserver'
       kubectl get pods --all-namespaces
       kubectl get pods -o wide --all-namespaces
       kubectl describe pods webserver-5cc69bf9c4-ts8xn
      
       kubectl describe service webserver
       ---
       NodePort:                 <unset>  32049/TCP
       Endpoints:                10.244.1.2:80,10.244.1.3:80,10.244.1.4:80 + 2 more...
       ---
 
       kubeadm token list                                                                  
       TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
       2w2bhj.c9jplb6mpr7mgjz6   23h         2021-04-18T21:56:10Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token      
                                                                                              .....izlistamo tokene 

      *Brisanje pojedinih elemenata kubernetes-a:
       
       kubectl delete nodes worker1
       kubectl delete pods webserver-5cc69bf9c4-ts8xn
       kubectl delete service webserver
       
       kubeadm reset                                                                          .....uklanja klaster tako da možemo da kreiramo novi

       
     *Provera:
      
      a. Na ubuntu18kubemaster virtuelnoj mašini
      
      curl  http://192.168.99.32:32049/ -> Welcome to nginx!
      curl  http://192.168.99.33:32049/ -> Welcome to nginx!
      
      b. U web browser-u na domaćinu

      Web browser -> http://192.168.99.32:32049 -> Welcome to nginx!
      Web browser -> http://192.168.99.33:32049 -> Welcome to nginx!
      
      
      
      Napomena: Umesto Flanel mrežnog dodatka, možemo inicirati Calico pod network dodatak
                U tom slučaju, u naredbi kojom iniciramo klaster, moramo uneti parametre mreže za Calico
      
                sudo kubeadm init --apiserver-advertise-address 192.168.99.31 --pod-network-cidr=192.168.150.0/23    .....komanda za iniciranje klastera na master 
                                                                                                                          mašini
     
                curl https://docs.projectcalico.org/manifests/calico.yaml -O                                         .....pribavimo calico.yaml fajl
      
                sudo vim calico.yaml                                                                                 .....otvorimo calico.yaml fajl
                        - name: CALICO_IPV4POOL_CIDR                                                                      .....otkomentarišemo varijablu
                          value: "192.168.150.0/23"                                                                       .....otkomentarišemo vrednost i upišemo  
                                                                                                                               raspon ip adresa za podove u klasteru
                                                                                                                       
                kubectl apply -f calico.yaml                                                                         .....primenimo podešavanje
     
                ili
  
                kubectl apply -f https://docs.projectcalico.org/v3.14/manifests/calico.yaml                          .....skinemo calico.yaml fajl i primenimo 
                                                                                                                          podešavanja iz njega
      
      
      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      
      NAPOMENA: Lakši način konfiguracije kubernetes klastera je pokretanje tri sistema (mastern worker1 i worker2) preko vagrant aplikacije 
                (pogledati odeljak vagrant) uz korišćenje gotovih skripti pribavljenih na github-u (koje možemo dodatno editovati)
      
                git clone https://github.com/mbaykara/k8s-cluster.git
                
                cd k8s-cluster 
               
                vim Vagrant                                     .....otvorimo Vagrantfile i izmenimo hostname virtuelnih mašina, statičke ip adrese
                                                                     (uskladimo ih sa podešavanjem na Host Network Manager-u VirtualBox-a), veličinu RAM
                                                                     memorije itd.
                
                vim k8s-setup-master.sh                         .....prilikom dizanja tri ubuntu 18.04 mašine, Vagrantfile poziva k8s-setup-master.sh fajl koji
                   ---                                               izvršava podešavanje navedenih mašina; u navedenom fajlu izvršimo izmene u skladu sa
                   # Update /etc/hosts about other hosts             onim što smo izmenili u Vagrantfile a tiče se izmene hostname i ip adrese mašina
                   cat >> /etc/hosts <<EOF
                   192.168.99.31 kubemaster
                   192.168.99.32 worker1
                   192.168.99.33 worker2
                   EOF
                   ---
                
                vagrant up                                      .....kad smo sve podesili pokrećemo vagrant koji instalira tri mašine ubuntu 18.04                                           
                                                                     (kubemaster, worker1, worker2) 
                                                                     
               -Master mašina:
                
                vagrant ssh kubemaster                          .....nakon instaliranja mašina, konektujemo se, prvo na master mašinu
                
                sudo kubeadm init --apiserver-advertise-address 192.168.99.31 --pod-network-cidr=10.244.0.0/16     .....dobijemo izlaz:
                kubeadm join 192.168.99.31:6443 --token 2w2bhj.c9jplb6mpr7mgjz6 \
                --discovery-token-ca-cert-hash sha256:8054fa89a15d5dc71a5478a8f9dcd6b9932ba8abfd06f2303613e0387e56d22b
                
                mkdir -p $HOME/.kube
                sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
                sudo chown $(id -u):$(id -g) $HOME/.kube/config
      
                sudo kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
      
                sudo vim /etc/kubernetes/manifests/kube-scheduler.yaml
                        - -- port=0                                                                         .....izbrisati liniju
                sudo vim /etc/kubernetes/manifests/kube-controller-manager.yaml
                        - -- port=0                                                                         .....izbrisati liniju
                sudo systemctl restart kubelet.service   
                
                
               *Primenimo Nginx i 5 primeraka web servera:
               
                kubectl create deployment nginx --image=nginx --port 80                         
                kubectl create deployment webserver --image=nginx --port 80 --replicas=5
                kubectl expose deployment webserver --port 80 --type=NodePort
    
                kubectl describe service webserver
                ---
                NodePort:                 <unset>  32049/TCP
                Endpoints:                10.244.1.2:80,10.244.1.3:80,10.244.1.4:80 + 2 more...
                  
                  
               -Worker1 mašina:
               
                vagrant ssh worker1
                sudo kubeadm join 192.168.99.31:6443 --token 2w2bhj.c9jplb6mpr7mgjz6 \
                --discovery-token-ca-cert-hash sha256:8054fa89a15d5dc71a5478a8f9dcd6b9932ba8abfd06f2303613e0387e56d22b
              
               -Worker2 mašina:
               
                vagrant ssh worker2
                sudo kubeadm join 192.168.99.31:6443 --token 2w2bhj.c9jplb6mpr7mgjz6 \
                --discovery-token-ca-cert-hash sha256:8054fa89a15d5dc71a5478a8f9dcd6b9932ba8abfd06f2303613e0387e56d22b   
                                      
                                      
                                      
               *Provera:
      
                a. Na ubuntu18kubemaster virtuelnoj mašini
      
                   curl  http://192.168.99.32:32049/ -> Welcome to nginx!
                   curl  http://192.168.99.33:32049/ -> Welcome to nginx!
      
                b. U web browser-u na domaćinu

                   Web browser -> http://192.168.99.32:32049 -> Welcome to nginx!
                   Web browser -> http://192.168.99.33:32049 -> Welcome to nginx!                      
                                      
                                      
                                      
